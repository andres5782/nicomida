<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nicomida ‚Äì Modo Simple (v5 FINAL)</title>
<style>
  :root{
    --bg:#f7fbff;--card:#ffffff;--ink:#0b1324;--muted:#64748b;--line:#e5e7eb;
    --brand:#8b5cf6;--brand2:#22d3ee;--ok:#34d399;--warn:#fbbf24;--bad:#f87171;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  body{background:radial-gradient(900px 600px at 0% -10%, #ffecec 0, transparent 50%),
        radial-gradient(900px 600px at 100% -10%, #e7faff 0, transparent 50%),
        var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1100px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:18px;display:flex;align-items:center;gap:10px}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#efe9ff;color:#4c1d95;border:1px solid #ddd6fe}
  nav{display:flex;gap:8px;padding:8px 14px}
  nav button{flex:1;padding:10px 12px;border:1px solid var(--line);background:#fff;border-radius:14px;cursor:pointer;color:var(--muted);font-weight:600}
  nav button.active{background:#ecfeff;border-color:#a5f3fc;color:#164e63}
  #login-bar{font-size:13px;color:#334155}
  #login-bar button{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  main{max-width:1100px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.05)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea,button{border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px;font-size:14px}
  input,select,textarea{width:100%}
  .btn{background:#fafafa}
  .btn.primary{background:var(--brand);border-color:#7c3aed;color:#fff;font-weight:700}
  .btn.alt{background:#a7f3d0;border-color:#6ee7b7;color:#064e3b;font-weight:700}
  .suggestion{border:1px solid var(--line);border-radius:14px;padding:10px;margin:8px 0;display:flex;justify-content:space-between;gap:12px;background:#fcfdfd}
  .list-item{display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--line);border-radius:12px;padding:8px;margin:6px 0;background:#fff}
  .section-title{font-weight:800;margin:12px 0 6px}
  .small{font-size:12px;color:var(--muted)}
  .hidden{display:none}
  .meter{position:relative;height:16px;border-radius:999px;background:linear-gradient(90deg,#fecaca,#fde68a,#bbf7d0);border:1px solid var(--line)}
  .needle{position:absolute;top:-6px;transform:translateX(-50%);height:28px;width:2px;background:#111;border-radius:2px}
  .meter-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}
  .proscons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
  .proscons .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .proscons ul{margin:6px 0 0 18px;padding:0}
  .stack{display:flex;flex-direction:column;gap:10px}
  .stack .entry{display:flex;flex-direction:column;gap:6px}
  .stack .row-save{display:flex;gap:8px}
  .stack .row-save input{flex:1}
  .stack .row-save button{width:44px}
  .plan-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .slot{border:1px solid var(--line);border-radius:14px;padding:8px;background:#fff}
  .slot.pending{outline:2px dashed var(--bad);background:#fff5f5}
  .slot.confirmed{outline:2px solid var(--ok);background:#f0fdf4}
  .slot .actions{display:flex;gap:6px;margin-top:6px}
  .slot .actions .icon{padding:6px 10px;border:1px solid var(--line);border-radius:12px;background:#f3f4f6;cursor:pointer}
  details.tests{margin:12px 0}
  details.tests summary{cursor:pointer}
  .pass{color:#16a34a}.fail{color:#b91c1c}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üçΩÔ∏è Nicomida ‚Äì Modo Simple <span class="badge">v5 FINAL</span></h1>
    <div id="login-bar">Cargando sesi√≥n‚Ä¶</div>
  </div>
  <nav class="wrap">
    <button class="active" data-tab="hoy">Hoy</button>
    <button data-tab="plan">Plan semanal</button>
    <button data-tab="lista">Lista</button>
  </nav>
</header>

<main>
  <section id="hoy" class="card">
    <div class="row">
      <div class="col">
        <label>Fecha</label>
        <input type="date" id="hoy-date" />
      </div>
      <div class="col">
        <label>Turno principal</label>
        <select id="hoy-turno"><option value="comida">Comida</option><option value="cena">Cena</option></select>
      </div>
      <div class="col" style="align-self:end"><button class="btn primary" id="btn-hoy-sugerir">Sugerir ideas</button></div>
    </div>

    <div id="hoy-sug-list" class="row" style="margin-top:10px"></div>
    <div class="row"><div class="col" style="align-self:start"><button class="btn" id="btn-hoy-mas">üîÑ M√°s ideas</button></div></div>

    <div class="section-title">¬øLe diste otra cosa en la <span id="label-turno">Comida</span>? (texto libre)</div>
    <div class="row">
      <div class="col"><input id="alt-plato" placeholder="Ej.: aguacate con pasta corta y calabac√≠n, con aceite de oliva" /></div>
      <div class="col" style="align-self:end"><button class="btn" id="btn-parse-alt">üíæ Guardar alternativa</button></div>
    </div>

    <div class="section-title">Otras tomas del d√≠a</div>
    <div class="stack">
      <div class="entry">
        <label>Desayuno</label>
        <div class="row-save"><input id="txt-desayuno" placeholder="leche con avena y kiwi" /><button class="btn" id="save-des">üíæ</button></div>
      </div>
      <div class="entry">
        <label>Snack ma√±ana</label>
        <div class="row-save"><input id="txt-snack" placeholder="yogur con pl√°tano" /><button class="btn" id="save-snack">üíæ</button></div>
      </div>
      <div class="entry">
        <label>Merienda</label>
        <div class="row-save"><input id="txt-merienda" placeholder="pera y galleta de avena" /><button class="btn" id="save-mer">üíæ</button></div>
      </div>
    </div>

    <div class="section-title">Puntaje nutricional del d√≠a</div>
    <div class="meter" id="meter"><div class="needle" id="needle" style="left:50%"></div></div>
    <div class="meter-labels"><span>0</span><span>2</span><span>4</span><span>6</span><span>8</span><span>10</span></div>
    <div class="proscons">
      <div class="box"><b>‚úÖ Puntos a favor</b><ul id="pros-list"></ul></div>
      <div class="box"><b>‚ö†Ô∏è Lo que falt√≥/mejorar</b><ul id="cons-list"></ul></div>
    </div>

    <div class="section-title">Historial del d√≠a</div>
    <div id="hoy-historial"></div>
  </section>

  <section id="plan" class="card hidden">
    <div class="small">Rellena ideas (rojo = pendiente). Confirma (verde) o üîÑ regenera por comida. Puedes <b>editar a mano</b> cada casilla.</div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Semana que empieza</label><input type="date" id="week-start" /></div>
      <div class="col" style="align-self:end"><button class="btn alt" id="btn-auto-plan">Rellenar con ideas</button><button class="btn" id="btn-guardar-plan">Guardar plan</button></div>
    </div>
    <div id="plan-grid" class="plan-grid" style="margin-top:12px"></div>
    <div class="small" id="plan-msg"></div>
  </section>

  <section id="lista" class="card hidden">
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Desde</label><input type="date" id="list-from" /></div>
      <div class="col"><label>Hasta</label><input type="date" id="list-to" /></div>
      <div class="col" style="align-self:end"><button class="btn primary" id="btn-generar-lista">Generar lista</button><button class="btn" id="btn-copiar-lista">Copiar</button></div>
    </div>
    <div id="lista-contenido" style="margin-top:10px"></div>
  </section>

  <details class="tests card" style="margin-top:10px">
    <summary>üîß Autotests</summary>
    <ul id="test-results" class="small"></ul>
  </details>
</main>

<script>
// ===== Util
const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const todayStr=()=> new Date().toISOString().slice(0,10);
const weekDays=["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
const mealLabels={desayuno:"Desayuno", snack_am:"Snack ma√±ana", comida:"Comida", merienda:"Merienda", cena:"Cena"};

// ===== Estado
const KEY='nicomida_v5final';
let state=load();
function load(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) return {logs:{},plans:{}};
    const parsed=JSON.parse(raw);
    if(parsed && typeof parsed==='object' && 'logs' in parsed && 'plans' in parsed) return parsed;
    localStorage.removeItem(KEY); return {logs:{},plans:{}};
  }catch(e){ try{localStorage.removeItem(KEY);}catch(_){} return {logs:{},plans:{}}; }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

// ===== Reglas y l√©xico
const PROH={ ingredientes:["tomate","remolacha"], nocturnos:["br√≥coli","brocoli"], maxEggs:5, maxLentejas:1, maxRedMeat:1 };
const LEX={
  'aceite de oliva':{norm:'aceite de oliva', cats:['grasa']}, 'aceite':{norm:'aceite de oliva', cats:['grasa']},
  'pasta corta':{norm:'pasta', cats:['cereal']}, 'pasta':{norm:'pasta', cats:['cereal']}, 'fideos':{norm:'pasta', cats:['cereal']},
  'arroz':{norm:'arroz', cats:['cereal']}, 'quinoa':{norm:'quinoa', cats:['cereal']}, 'cusc√∫s':{norm:'cusc√∫s', cats:['cereal']}, 'cous cous':{norm:'cusc√∫s', cats:['cereal']}, 'pan':{norm:'pan', cats:['cereal']}, 'avena':{norm:'avena', cats:['cereal']},
  'patata':{norm:'patata', cats:['tub√©rculo']}, 'boniato':{norm:'boniato', cats:['tub√©rculo']},
  'pollo':{norm:'pollo', cats:['prote√≠na','carne_blanca']}, 'pavo':{norm:'pavo', cats:['prote√≠na','carne_blanca']}, 'ternera':{norm:'ternera', cats:['prote√≠na','carne_roja']}, 'tortilla':{norm:'huevo', cats:['prote√≠na','huevo']},
  'huevo':{norm:'huevo', cats:['prote√≠na','huevo']}, 'lentejas':{norm:'lentejas', cats:['prote√≠na','legumbre']}, 'garbanzos':{norm:'garbanzos', cats:['prote√≠na','legumbre']},
  'merluza':{norm:'merluza', cats:['prote√≠na','pescado_blanco']}, 'pescado blanco':{norm:'merluza', cats:['prote√≠na','pescado_blanco']}, 'salm√≥n':{norm:'salm√≥n', cats:['prote√≠na','pescado_azul']}, 'salmon':{norm:'salm√≥n', cats:['prote√≠na','pescado_azul']},
  'calabaza':{norm:'calabaza', cats:['verdura']}, 'calabac√≠n':{norm:'calabac√≠n', cats:['verdura']}, 'calabacin':{norm:'calabac√≠n', cats:['verdura']},
  'zanahoria':{norm:'zanahoria', cats:['verdura']}, 'br√≥coli':{norm:'br√≥coli', cats:['verdura']}, 'brocoli':{norm:'br√≥coli', cats:['verdura']}, 'cebolla':{norm:'cebolla', cats:['verdura']}, 'berenjena':{norm:'berenjena', cats:['verdura']}, 'ma√≠z':{norm:'ma√≠z', cats:['cereal']}, 'maiz':{norm:'ma√≠z', cats:['cereal']},
  'aguacate':{norm:'aguacate', cats:['fruta','grasa']}, 'manzana':{norm:'manzana', cats:['fruta']}, 'pera':{norm:'pera', cats:['fruta']}, 'pl√°tano':{norm:'pl√°tano', cats:['fruta']}, 'platano':{norm:'pl√°tano', cats:['fruta']}, 'kiwi':{norm:'kiwi', cats:['fruta']},
  'leche':{norm:'leche', cats:['l√°cteo']}, 'yogur':{norm:'yogur', cats:['l√°cteo']}, 'queso fresco':{norm:'queso fresco', cats:['l√°cteo']}
};
const MULTI=Object.keys(LEX).filter(k=>k.includes(' ')).sort((a,b)=>b.length-a.length);
function toAsciiLower(s){ const map={"√°":"a","√©":"e","√≠":"i","√≥":"o","√∫":"u","√º":"u","√±":"n"}; return s.toLowerCase().split('').map(ch=>map[ch]||ch).join(''); }
function parseFree(text){ const original=(text||'').trim(); if(!original) return null; let t=' '+toAsciiLower(original)+' '; const found=new Set(), cats=new Set(); MULTI.forEach(ph=>{ const p=' '+toAsciiLower(ph)+' '; if(t.includes(p)){ found.add(LEX[ph].norm); (LEX[ph].cats||[]).forEach(c=>cats.add(c)); t=t.split(p).join(' ');} }); t.split(/,| y | con | de |\+/g).map(s=>s.trim()).filter(Boolean).forEach(tok=>{ tok=tok.replace(/\b\d+[\w¬™¬∫]*\b/g,'').trim(); if(!tok) return; const k=LEX[tok]?tok:(tok.endsWith('s')?tok.slice(0,-1):tok); if(LEX[k]){ found.add(LEX[k].norm); (LEX[k].cats||[]).forEach(c=>cats.add(c)); } }); [...found].forEach(i=>{ if(PROH.ingredientes.includes(i)) found.delete(i); }); return {dish:original, ingredients:[...found], categories:[...cats], ts:Date.now()}; }

// ===== Ideas (todas P+C+V)
const BANK={ base:[
  {title:"Pollo con arroz y calabac√≠n", ing:['pollo','arroz','calabac√≠n','aceite de oliva']},
  {title:"Pollo con cusc√∫s y calabaza", ing:['pollo','cusc√∫s','calabaza','aceite de oliva']},
  {title:"Pollo con pasta y zanahoria", ing:['pollo','pasta','zanahoria','aceite de oliva']},
  {title:"Pollo con quinoa y berenjena", ing:['pollo','quinoa','berenjena','aceite de oliva']},
  {title:"Pavo con boniato y zanahoria", ing:['pavo','boniato','zanahoria','aceite de oliva']},
  {title:"Pavo con arroz y berenjena", ing:['pavo','arroz','berenjena','aceite de oliva']},
  {title:"Pavo con pasta y calabac√≠n", ing:['pavo','pasta','calabac√≠n','aceite de oliva']},
  {title:"Pavo con cusc√∫s y calabaza", ing:['pavo','cusc√∫s','calabaza','aceite de oliva']},
  {title:"Ternera con patata y calabaza", ing:['ternera','patata','calabaza','aceite de oliva']},
  {title:"Merluza con patata y calabac√≠n", ing:['merluza','patata','calabac√≠n','aceite de oliva']},
  {title:"Merluza con boniato y zanahoria", ing:['merluza','boniato','zanahoria','aceite de oliva']},
  {title:"Merluza con arroz y calabac√≠n", ing:['merluza','arroz','calabac√≠n','aceite de oliva']},
  {title:"Salm√≥n con arroz y calabaza", ing:['salm√≥n','arroz','calabaza','aceite de oliva']},
  {title:"Salm√≥n con cusc√∫s y calabac√≠n", ing:['salm√≥n','cusc√∫s','calabac√≠n','aceite de oliva']},
  {title:"Salm√≥n con pasta y zanahoria", ing:['salm√≥n','pasta','zanahoria','aceite de oliva']},
  {title:"Garbanzos con arroz y verduras", ing:['garbanzos','arroz','calabac√≠n','zanahoria','aceite de oliva']},
  {title:"Garbanzos con cusc√∫s y calabaza", ing:['garbanzos','cusc√∫s','calabaza','aceite de oliva']},
  {title:"Lentejas con arroz y verduras", ing:['lentejas','arroz','calabac√≠n','zanahoria','aceite de oliva']},
  {title:"Tortilla con calabac√≠n y cebolla", ing:['huevo','calabac√≠n','cebolla','aceite de oliva']},
  {title:"Pasta corta con merluza y calabac√≠n", ing:['pasta','merluza','calabac√≠n','aceite de oliva']},
  {title:"Arroz con verduras y pollo", ing:['arroz','pollo','calabac√≠n','zanahoria','aceite de oliva']},
  {title:"Quinoa con salm√≥n y calabac√≠n", ing:['quinoa','salm√≥n','calabac√≠n','aceite de oliva']},
  {title:"Cous cous con pavo y berenjena", ing:['cusc√∫s','pavo','berenjena','aceite de oliva']},
  {title:"Arroz con garbanzos y calabaza", ing:['arroz','garbanzos','calabaza','aceite de oliva']}
]};
function ingCats(ing){ const cats=new Set(); (ing||[]).forEach(i=> (LEX[i]?.cats||[]).forEach(c=>cats.add(c))); return cats; }
function isBalanced(ing){ const cats=ingCats(ing); return cats.has('prote√≠na') && (cats.has('cereal')||cats.has('tub√©rculo')) && cats.has('verdura'); }

// ‚Äî‚Äî Diversidad helpers ‚Äî‚Äî
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function titleKey(t){ return (t||'').toLowerCase().trim(); }
function proteinKeyFromIng(ing){ ing=ing||[]; if(ing.includes('huevo')) return 'huevo'; if(ing.includes('lentejas')) return 'legumbre_lenteja'; if(ing.includes('garbanzos')) return 'legumbre_garb'; if(ing.includes('ternera')) return 'carne_roja'; if(ing.includes('pollo')||ing.includes('pavo')) return 'carne_blanca'; if(ing.includes('merluza')) return 'pescado_blanco'; if(ing.includes('salm√≥n')) return 'pescado_azul'; return 'prote√≠na'; }
function weekStartOf(dateStr){ const d=new Date(dateStr); const day=(d.getUTCDay()+6)%7; d.setUTCDate(d.getUTCDate()-day); return d.toISOString().slice(0,10); }
function inWeekRange(dateStr, weekStart){ const d=new Date(dateStr); const w=new Date(weekStart); const diff=(d-w)/86400000; return diff>=0 && diff<7; }
function countersWeek(weekStart){ let eggs=0,lent=0,red=0; for(const d in state.logs){ if(inWeekRange(d,weekStart)){ const day=state.logs[d]; Object.values(day).forEach(e=>{ const ing=e?.ingredients||[]; if(ing.includes('huevo')) eggs++; if(ing.includes('lentejas')) lent++; if(ing.includes('ternera')) red++; }); } } return {eggs,lent,red}; }
function weekDishSet(ws){ const set=new Set(); (state.plans[ws]||[]).forEach(d=>{ ['comida','cena'].forEach(t=>{ if(d[t]?.title) set.add(titleKey(d[t].title)); }); }); for(const date in state.logs){ if(inWeekRange(date,ws)){ const day=state.logs[date]; ['comida','cena'].forEach(t=>{ if(day[t]?.dish) set.add(titleKey(day[t].dish)); }); } } return set; }
function weekCounts(ws){ let eggs=0,lent=0,red=0; const fromLogs=countersWeek(ws); eggs+=fromLogs.eggs; lent+=fromLogs.lent; red+=fromLogs.red; (state.plans[ws]||[]).forEach(d=>{ ['comida','cena'].forEach(t=>{ const ing=d[t]?.ing||[]; if(ing.includes('huevo')) eggs++; if(ing.includes('lentejas')) lent++; if(ing.includes('ternera')) red++; }); }); return {eggs,lent,red}; }

function allowedFor(turno, x){ let tlist=[]; if(Array.isArray(x)) tlist=x; else if(typeof x==='string'){ const low=x.toLowerCase(); if(low.includes('tomate')||low.includes('remolacha')) return false; if(turno==='cena' && (low.includes('br√≥coli')||low.includes('brocoli'))) return false; return true; } tlist=(tlist||[]).map(s=> (''+s).toLowerCase()); if(tlist.some(s=> PROH.ingredientes.includes(s))) return false; if(turno==='cena' && (tlist.includes('br√≥coli')||tlist.includes('brocoli'))) return false; return true; }

function candidates(turno,dateStr){ const ws=weekStartOf(dateStr); let cand=[...BANK.base].map(x=>({title:x.title, ing:[...x.ing]})); cand=cand.filter(x=> isBalanced(x.ing) && allowedFor(turno,x.ing)); // contexto d√≠a
  const today=state.logs[dateStr]||{}; const dayCats=new Set(); Object.values(today).forEach(e=> (e?.ingredients||[]).forEach(i=> (LEX[i]?.cats||[]).forEach(c=>dayCats.add(c))));
  cand=cand.filter(item=>{ const cats=ingCats(item.ing); const wk=countersWeek(ws); if(item.ing.includes('huevo') && wk.eggs>=PROH.maxEggs) return false; if(item.ing.includes('lentejas') && wk.lent>=PROH.maxLentejas) return false; if(item.ing.includes('ternera') && wk.red>=PROH.maxRedMeat) return false; if((dayCats.has('carne_blanca')||dayCats.has('carne_roja')) && (cats.has('carne_blanca')||cats.has('carne_roja'))) return false; if(turno==='cena' && (cats.has('carne_blanca')||cats.has('carne_roja'))) return false; return true; });
  return cand; }

// ===== Registro & render d√≠a
function addLog(date,turno,entry){ if(!state.logs[date]) state.logs[date]={}; state.logs[date][turno]=entry; save(); }
function renderDayHistory(date){ const box=$('#hoy-historial'); box.innerHTML=''; const day=state.logs[date]||{}; ['desayuno','snack_am','comida','merienda','cena'].forEach(t=>{ if(day[t]){ const it=day[t]; const el=document.createElement('div'); el.className='list-item'; el.innerHTML=`<div><div><b>${mealLabels[t]}</b>: ${it.dish||''}</div><div class="small">${(it.ingredients||[]).join(', ')}</div></div><button class="btn">Eliminar</button>`; el.querySelector('button').onclick=()=>{ delete day[t]; save(); renderDayHistory(date); updateMeter(); }; box.appendChild(el); } }); updateMeter(); }

// ===== Sugerencias HOY (2 fijas + paginaci√≥n)
function ensurePager(key, pool){ if(!state._pager) state._pager={}; if(!state._pager[key] || !Array.isArray(state._pager[key].pool) || !state._pager[key].pool.length){ state._pager[key]={pool:shuffle([...pool]), idx:0}; } }
function renderHoySuggestions(){ const turno=$('#hoy-turno').value; const date=$('#hoy-date').value; const list=$('#hoy-sug-list'); list.innerHTML=''; let pool=candidates(turno,date); const today=state.logs[date]||{}; const eatenTitles=new Set(Object.values(today).map(e=> titleKey(e?.dish))); pool=pool.filter(x=> !eatenTitles.has(titleKey(x.title))); ensurePager(date+'_'+turno, pool); const pager=state._pager[date+'_'+turno]; if(!pager.pool.length){ list.innerHTML='<div class="small">Sin ideas v√°lidas ahora mismo.</div>'; return; } if(pager.idx>=pager.pool.length){ pager.idx=0; pager.pool=shuffle(pager.pool); } const slice=pager.pool.slice(pager.idx, pager.idx+2); pager.idx+=2; save(); slice.forEach(it=>{ const el=document.createElement('div'); el.className='suggestion'; el.innerHTML=`<div><div style="font-weight:700">${it.title}</div><div class="small">${it.ing.join(', ')}</div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn primary">Registrar</button></div>`; const regBtn=el.querySelector('button'); regBtn.onclick=()=>{ const cats=ingCats(it.ing); addLog(date, turno, {dish:it.title, ingredients:it.ing, categories:[...cats], ts:Date.now()}); renderDayHistory(date); }; list.appendChild(el); }); }
// ===== Puntaje
function mealCompleteness(e){ if(!e) return 0; const cats=new Set(e.categories||[]); let s=0; if(cats.has('prote√≠na')) s+=0.4; if(cats.has('cereal')||cats.has('tub√©rculo')) s+=0.3; if(cats.has('verdura')) s+=0.3; return s; }
function updateMeter(){ const date=$('#hoy-date').value; const day=state.logs[date]||{}; const pros=[], cons=[]; const scMeal=mealCompleteness(day.comida); const scDinner=mealCompleteness(day.cena); if(scMeal===1) pros.push('Comida completa (P+C+V)'); else cons.push('Completar la comida con P+C+V'); if(scDinner===1) pros.push('Cena completa (P+C+V)'); else cons.push('Completar la cena con P+C+V'); const catsDay=new Set(); Object.values(day).forEach(e=> (e?.categories||[]).forEach(c=>catsDay.add(c)) ); if(catsDay.has('fruta')) pros.push('Incluiste fruta'); else cons.push('A√±adir fruta en alguna toma'); if(catsDay.has('grasa')||catsDay.has('grasa saludable')) pros.push('Grasa saludable presente'); let score=(scMeal+scDinner)*5; const w=countersWeek(weekStartOf(date)); if(w.eggs>PROH.maxEggs){ score-=1; cons.push('Huevo >5/sem'); } if(w.lent>PROH.maxLentejas){ score-=0.5; cons.push('Lentejas >1/sem'); } if(w.red>PROH.maxRedMeat){ score-=0.5; cons.push('Carne roja >1/sem'); } if(day.cena && (day.cena.ingredients||[]).includes('br√≥coli')){ score-=0.8; cons.push('Evitar br√≥coli por la noche'); } score=Math.max(0,Math.min(10,Math.round(score*2)/2)); $('#needle').style.left=(score*10)+'%'; $('#pros-list').innerHTML=pros.map(x=>`<li>${x}</li>`).join(''); $('#cons-list').innerHTML=cons.filter((v,i,a)=>a.indexOf(v)===i).map(x=>`<li>${x}</li>`).join(''); }

// ===== Plan semanal
function ensurePlan(ws){ if(!state.plans[ws]) state.plans[ws]=Array.from({length:7},()=>({comida:{},cena:{}})); }
function weekProteinByDay(ws){ const arr=[...Array(7)].map(()=>new Set()); const w=state.plans[ws]||[]; w.forEach((d,i)=>{ ['comida','cena'].forEach(t=>{ const ing=d[t]?.ing||[]; arr[i].add(proteinKeyFromIng(ing)); }); }); return arr; }
function chooseForTurn(turno, ds, ws, usedTitles, usedProtSet){ let cand=candidates(turno,ds); const wkCounts=weekCounts(ws); cand=cand.filter(x=> !usedTitles.has(titleKey(x.title))); const scored=cand.map(x=>{ const pk=proteinKeyFromIng(x.ing); let score=0; if(usedProtSet.has(pk)) score-=100; else score+=20; if(pk==='huevo' && wkCounts.eggs>=PROH.maxEggs) score=-Infinity; if(pk==='legumbre_lenteja' && wkCounts.lent>=PROH.maxLentejas) score=-Infinity; if(pk==='carne_roja' && wkCounts.red>=PROH.maxRedMeat) score=-Infinity; if(turno==='cena' && (pk==='carne_blanca'||pk==='carne_roja')) score-=20; score+=Math.random(); return {item:x,score,pk}; }).filter(o=>o.score>-Infinity); if(!scored.length){ cand=candidates(turno,ds); shuffle(cand); return cand[0]||BANK.base[0]; } scored.sort((a,b)=> b.score-a.score); return scored[0].item; }
function renderPlan(){ const grid=$('#plan-grid'); const ws=$('#week-start').value; ensurePlan(ws); grid.innerHTML=''; const week=state.plans[ws]; week.forEach((day,idx)=>{ const card=document.createElement('div'); card.className='card'; const date=new Date(ws); date.setUTCDate(date.getUTCDate()+idx); const ds=date.toISOString().slice(0,10); const slot=(t)=>{ const s=day[t]||{}; const st=s.confirmed?'confirmed':'pending'; return `<div class="slot ${st}" data-idx="${idx}" data-t="${t}"><div class="small"><b>${t==='comida'?'Comida':'Cena'}</b> <span class="small" style="opacity:.7">${ds}</span></div><input class="inp" value="${s.title||''}" placeholder="Idea de ${t}" /><div class="actions"><span class="icon regen" title="Regenerar">üîÑ</span><span class="icon confirm" title="Confirmar">‚úÖ</span></div></div>`; }; card.innerHTML=`<div style="font-weight:700;margin-bottom:6px">${weekDays[idx]}</div><div class="plan-grid">${slot('comida')}${slot('cena')}</div>`; grid.appendChild(card); }); $$('#plan-grid .slot').forEach(sl=>{ const idx=+sl.dataset.idx; const t=sl.dataset.t; const inp=sl.querySelector('.inp'); inp.oninput=e=>{ const ws=$('#week-start').value; const val=e.target.value; const parsed=parseFree(val)||{}; state.plans[ws][idx][t].title=val; state.plans[ws][idx][t].ing=parsed.ingredients||[]; state.plans[ws][idx][t].categories=parsed.categories||[]; save(); }; sl.querySelector('.regen').onclick=()=>{ const ws=$('#week-start').value; const date=new Date(ws); date.setUTCDate(date.getUTCDate()+idx); const ds=date.toISOString().slice(0,10); const pick=chooseForTurn(t, ds, ws, weekDishSet(ws), weekProteinByDay(ws)[idx]); state.plans[ws][idx][t]={title:pick.title, ing:pick.ing, categories:[...ingCats(pick.ing)], confirmed:false}; save(); renderPlan(); }; sl.querySelector('.confirm').onclick=()=>{ const ws=$('#week-start').value; const s=state.plans[ws][idx][t]; if(!s?.title) return alert('Escribe o genera una idea'); let ing=s.ing && s.ing.length? s.ing : (parseFree(s.title)||{}).ingredients || []; if(!isBalanced(ing)){ const cats=ingCats(ing); if(!(cats.has('cereal')||cats.has('tub√©rculo'))) ing.push('arroz'); if(!cats.has('verdura')) ing.push('calabac√≠n'); if(!cats.has('prote√≠na')) ing.push('pollo'); } s.ing=ing; s.categories=[...ingCats(ing)]; s.confirmed=true; save(); renderPlan(); }; }); }
function autoPlan(){ const ws=$('#week-start').value; ensurePlan(ws); const usedTitles=weekDishSet(ws); const dayProt=[...Array(7)].map(()=> new Set()); const counts=weekCounts(ws); for(let i=0;i<7;i++){ const d=new Date(ws); d.setUTCDate(d.getUTCDate()+i); const ds=d.toISOString().slice(0,10); ['comida','cena'].forEach(turno=>{ const pick=chooseForTurn(turno, ds, ws, usedTitles, dayProt[i]); state.plans[ws][i][turno]={title:pick.title, ing:pick.ing, categories:[...ingCats(pick.ing)], confirmed:false}; usedTitles.add(titleKey(pick.title)); const pk=proteinKeyFromIng(pick.ing); dayProt[i].add(pk); if(pick.ing.includes('huevo')) counts.eggs++; if(pick.ing.includes('lentejas')) counts.lent++; if(pick.ing.includes('ternera')) counts.red++; }); } save(); renderPlan(); }
function quickPlanFromSuggestionStruct(item){ const ws=$('#week-start').value||weekStartOf($('#hoy-date').value); ensurePlan(ws); const a=new Date(ws), b=new Date($('#hoy-date').value); const idx=Math.round((b-a)/86400000); if(idx<0||idx>6) return alert('La fecha no est√° en la semana seleccionada'); const t=$('#hoy-turno').value; if(!allowedFor(t,item.ing)) return alert('Sugerencia incompatible con tus reglas'); state.plans[ws][idx][t]={title:item.title, ing:item.ing, categories:[...ingCats(item.ing)], confirmed:false}; save(); renderPlan(); }

// ===== Lista de la compra
function generateList(){ const from=$('#list-from').value, to=$('#list-to').value; const items=new Set(); for(const date in state.logs){ if(date>=from&&date<=to){ Object.values(state.logs[date]).forEach(e=> (e.ingredients||[]).forEach(i=> items.add(i))); }} const ws=weekStartOf(from); (state.plans[ws]||[]).forEach((d,di)=>{ const dayDate=new Date(ws); dayDate.setUTCDate(dayDate.getUTCDate()+di); const ds=dayDate.toISOString().slice(0,10); if(ds>=from&&ds<=to){ ['comida','cena'].forEach(t=>{ const s=d[t]; if(s?.confirmed) (s.ing|| (parseFree(s.title)||{}).ingredients || []).forEach(i=> items.add(i)); }); } }); PROH.ingredientes.forEach(p=> items.delete(p)); const cont=$('#lista-contenido'); const arr=[...items].sort(); cont.innerHTML= arr.length? arr.map(i=>`<div class="list-item"><span>${i}</span><button class="btn">‚úîÔ∏è</button></div>`).join(''): '<div class="small">No hay ingredientes en el rango.</div>'; }
function copyList(){ const items=[...$('#lista-contenido').querySelectorAll('.list-item span')].map(el=>el.textContent); navigator.clipboard.writeText(items.join('\n')).then(()=>alert('Lista copiada ‚úÖ')); }

// ===== Tabs & init
function setTab(id){ ['hoy','plan','lista'].forEach(x=> $('#'+x).classList.toggle('hidden', x!==id)); $$('nav button').forEach(b=> b.classList.toggle('active', b.dataset.tab===id)); }
$$('nav button').forEach(b=> b.onclick=()=> setTab(b.dataset.tab));
function init(){ $('#hoy-date').value=todayStr(); $('#week-start').value=weekStartOf(todayStr()); $('#list-from').value=weekStartOf(todayStr()); const to=new Date($('#list-from').value); to.setUTCDate(to.getUTCDate()+6); $('#list-to').value=to.toISOString().slice(0,10); $('#label-turno').textContent=$('#hoy-turno').selectedOptions[0].textContent; renderHoySuggestions(); renderDayHistory($('#hoy-date').value); renderPlan(); }
$('#btn-hoy-sugerir').onclick=renderHoySuggestions; $('#btn-hoy-mas').onclick=renderHoySuggestions; $('#hoy-turno').onchange=()=> $('#label-turno').textContent=$('#hoy-turno').selectedOptions[0].textContent; $('#btn-parse-alt').onclick=()=>{ const s=$('#alt-plato').value.trim(); if(!s) return alert('Escribe la alternativa'); const e=parseFree(s); const date=$('#hoy-date').value; const turno=$('#hoy-turno').value; addLog(date, turno, e); $('#alt-plato').value=''; renderDayHistory(date); }; $('#save-des').onclick=()=>{ const v=$('#txt-desayuno').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'desayuno',parseFree(v)); $('#txt-desayuno').value=''; renderDayHistory(d); }; $('#save-snack').onclick=()=>{ const v=$('#txt-snack').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'snack_am',parseFree(v)); $('#txt-snack').value=''; renderDayHistory(d); }; $('#save-mer').onclick=()=>{ const v=$('#txt-merienda').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'merienda',parseFree(v)); $('#txt-merienda').value=''; renderDayHistory(d); }; $('#hoy-date').onchange=()=> renderDayHistory($('#hoy-date').value); $('#btn-auto-plan').onclick=autoPlan; $('#btn-guardar-plan').onclick=()=>{ save(); alert('Plan guardado ‚úÖ'); }; $('#week-start').onchange=renderPlan; $('#btn-generar-lista').onclick=generateList; $('#btn-copiar-lista').onclick=copyList; if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();

// ===== Autotests m√≠nimos (no tocan tu estado)
function runTests(){ const results=[]; const ok=(name,cond)=>results.push({name,pass:!!cond}); try{ const p1=parseFree('leche con avena y kiwi'); ok('parser b√°sico', p1 && ['leche','avena','kiwi'].every(x=>p1.ingredients.includes(x))); ok('prohibidos filtrados', (parseFree('tomate, remolacha').ingredients||[]).length===0); $('#hoy-date').value=todayStr(); $('#hoy-turno').value='comida'; renderHoySuggestions(); const cards=[...document.querySelectorAll('#hoy-sug-list .suggestion')]; ok('hoy: exactamente 2', cards.length===2); $('#week-start').value=weekStartOf(todayStr()); autoPlan(); const titles=[...document.querySelectorAll('#plan-grid .inp')].map(i=>i.value).filter(Boolean); const uniq=new Set(titles); ok('plan: sin repetidos', titles.length===uniq.size); }catch(e){ ok('tests ejec', false); console.error(e); } const ul=document.querySelector('#test-results'); if(ul){ ul.innerHTML=''; results.forEach(r=>{ const li=document.createElement('li'); li.className=r.pass?'pass':'fail'; li.textContent=(r.pass?'‚úî ':'‚úñ ')+r.name; ul.appendChild(li); }); } }
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', runTests); else runTests();
</script>

<!-- ===== Login email/contrase√±a auto (opcional, no rompe si no hay config) ===== -->
<script>
(function(){
  const bar=document.getElementById('login-bar');
  function showAnon(){ bar.innerHTML='<span class="small">Modo sin login</span>'; }
  function showUser(name){ bar.innerHTML='üëã '+name+' ¬∑ <button id="btn-out">Salir</button>'; document.getElementById('btn-out').onclick=()=>{ if(window.firebase?.auth){ return window.firebase.auth().signOut(); } if(window._authV9){ return window._authV9.signOut(); } } }
  function showSignin(onSubmit){ bar.innerHTML='<form id="login-form" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">'+
    '<input id="auth-email" type="email" placeholder="email" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:999px">'+
    '<input id="auth-pass" type="password" placeholder="contrase√±a" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:999px">'+
    '<button type="submit">Entrar</button>'+
    '<button type="button" id="btn-reg">Crear</button>'+
  '</form>'; const f=document.getElementById('login-form'); const reg=document.getElementById('btn-reg'); f.onsubmit=(e)=>{ e.preventDefault(); const email=document.getElementById('auth-email').value.trim(); const pass=document.getElementById('auth-pass').value; onSubmit('signin', email, pass); }; reg.onclick=()=>{ const email=document.getElementById('auth-email').value.trim(); const pass=document.getElementById('auth-pass').value; onSubmit('signup', email, pass); } }

  // v8 ya cargado
  try{
    if(window.firebase && window.firebase.apps && window.firebase.apps.length){ const auth=window.firebase.auth(); auth.onAuthStateChanged(function(user){ if(user) showUser(user.email||user.uid); else showSignin(async(mode,email,pass)=>{ try{ if(mode==='signup') await auth.createUserWithEmailAndPassword(email,pass); else await auth.signInWithEmailAndPassword(email,pass); }catch(err){ alert(err.message||'Error de autenticaci√≥n'); } }); }); return; }
  }catch(e){ console.warn('Firebase v8 detectado pero fall√≥', e); }

  // v9+ modular si hay config global
  const cfg = window.FIREBASE_CONFIG || window.firebaseConfig || window.__FBCONFIG || (function(){ try{ const tag=document.getElementById('firebase-config'); return tag? JSON.parse(tag.textContent): null; }catch(_){ return null } })();
  if(cfg){ (async function(){ try{ const appMod=await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'); const authMod=await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js'); const app=appMod.initializeApp(cfg); const auth=authMod.getAuth(app); window._authV9={signOut:()=>authMod.signOut(auth)}; authMod.onAuthStateChanged(auth,(user)=>{ if(user) showUser(user.email||user.uid); else showSignin(async(mode,email,pass)=>{ try{ if(mode==='signup') await authMod.createUserWithEmailAndPassword(auth,email,pass); else await authMod.signInWithEmailAndPassword(auth,email,pass); }catch(err){ alert(err.message||'Error de autenticaci√≥n'); } }); }); }catch(e){ console.warn('No se pudo inicializar Firebase v9+', e); showAnon(); } })(); return; }

  // Nada detectado ‚Üí modo local
  showAnon();
})();
</script>
</body>
</html>
