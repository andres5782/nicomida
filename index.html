<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nicomida ‚Äì Modo Simple (v4.4)</title>
<style>
  :root{--bg:#f6fbff;--card:#ffffff;--ink:#0b1324;--muted:#64748b;--line:#e5e7eb;--brand:#10b981;--brand2:#22d3ee}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  body{background:radial-gradient(1200px 800px at 10% -10%, #e9fbf3 0, transparent 40%),radial-gradient(1000px 700px at 110% -10%, #e6faff 0, transparent 40%),var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1100px;margin:0 auto;padding:8px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eafff5;color:#065f46;border:1px solid #a7f3d0}
  nav{display:flex;gap:8px;padding:8px 14px}
  nav button{flex:1;padding:10px 12px;border:1px solid var(--line);background:#fff;border-radius:14px;cursor:pointer;color:var(--muted);font-weight:600}
  nav button.active{background:#eafff5;border-color:#a7f3d0;color:#065f46}
  #login-bar{font-size:13px;color:#334155}
  #login-bar button{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  main{max-width:1100px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(16,185,129,.07)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea,button{border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px;font-size:14px}
  input,select,textarea{width:100%}
  .btn{background:#f9fafb}
  .btn.primary{background:var(--brand);border-color:#059669;color:#06290f;font-weight:700}
  .btn.alt{background:var(--brand2);border-color:#0891b2;color:#05222a;font-weight:700}
  .suggestion{border:1px solid var(--line);border-radius:14px;padding:10px;margin:8px 0;display:flex;justify-content:space-between;gap:12px;background:#fcfdfd}
  .list-item{display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--line);border-radius:12px;padding:8px;margin:6px 0;background:#fff}
  .section-title{font-weight:800;margin:12px 0 6px}
  .small{font-size:12px;color:var(--muted)}
  .hidden{display:none}
  .meter{position:relative;height:16px;border-radius:999px;background:linear-gradient(90deg,#fecaca,#fde68a,#bbf7d0);border:1px solid var(--line)}
  .needle{position:absolute;top:-6px;transform:translateX(-50%);height:28px;width:2px;background:#111;border-radius:2px}
  .meter-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}
  .proscons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
  .proscons .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .proscons ul{margin:6px 0 0 18px;padding:0}
  .stack{display:flex;flex-direction:column;gap:10px}
  .stack .entry{display:flex;flex-direction:column;gap:6px}
  .stack .row-save{display:flex;gap:8px}
  .stack .row-save input{flex:1}
  .stack .row-save button{width:44px}
  .plan-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .slot{border:1px solid var(--line);border-radius:14px;padding:8px;background:#fff}
  .slot.pending{outline:2px dashed #fca5a5;background:#fff5f5}
  .slot.confirmed{outline:2px solid #bbf7d0;background:#f0fdf4}
  .slot .actions{display:flex;gap:6px;margin-top:6px}
  .slot .actions .icon{padding:6px 10px;border:1px solid var(--line);border-radius:12px;background:#f3f4f6;cursor:pointer}
  details.tests{margin:12px 0}
  details.tests summary{cursor:pointer}
  .pass{color:#16a34a}.fail{color:#b91c1c}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üçΩÔ∏è Nicomida ‚Äì Modo Simple <span class="badge">v4.4</span></h1>
    <div id="login-bar">Cargando sesi√≥n‚Ä¶</div>
  </div>
  <nav class="wrap">
    <button class="active" data-tab="hoy">Hoy</button>
    <button data-tab="plan">Plan semanal</button>
    <button data-tab="lista">Lista</button>
  </nav>
</header>

<main>
  <section id="hoy" class="card">
    <div class="row">
      <div class="col">
        <label>Fecha</label>
        <input type="date" id="hoy-date" />
      </div>
      <div class="col">
        <label>Turno principal</label>
        <select id="hoy-turno"><option value="comida">Comida</option><option value="cena">Cena</option></select>
      </div>
      <div class="col" style="align-self:end"><button class="btn primary" id="btn-hoy-sugerir">Sugerir ideas</button></div>
    </div>

    <div id="hoy-sug-list" class="row" style="margin-top:10px"></div>

    <div class="section-title">¬øLe diste otra cosa en la <span id="label-turno">Comida</span>? (texto libre)</div>
    <div class="row">
      <div class="col"><input id="alt-plato" placeholder="Ej.: aguacate con pasta corta y calabac√≠n, con aceite de oliva" /></div>
      <div class="col" style="align-self:end"><button class="btn" id="btn-parse-alt">üíæ Guardar alternativa</button></div>
    </div>

    <div class="section-title">Otras tomas del d√≠a</div>
    <div class="stack">
      <div class="entry">
        <label>Desayuno</label>
        <div class="row-save"><input id="txt-desayuno" placeholder="leche con avena y kiwi" /><button class="btn" id="save-des">üíæ</button></div>
      </div>
      <div class="entry">
        <label>Snack ma√±ana</label>
        <div class="row-save"><input id="txt-snack" placeholder="yogur con pl√°tano" /><button class="btn" id="save-snack">üíæ</button></div>
      </div>
      <div class="entry">
        <label>Merienda</label>
        <div class="row-save"><input id="txt-merienda" placeholder="pera y galleta de avena" /><button class="btn" id="save-mer">üíæ</button></div>
      </div>
    </div>

    <div class="section-title">Puntaje nutricional del d√≠a</div>
    <div class="meter" id="meter"><div class="needle" id="needle" style="left:50%"></div></div>
    <div class="meter-labels"><span>0</span><span>2</span><span>4</span><span>6</span><span>8</span><span>10</span></div>
    <div class="proscons">
      <div class="box"><b>‚úÖ Puntos a favor</b><ul id="pros-list"></ul></div>
      <div class="box"><b>‚ö†Ô∏è Lo que falt√≥/mejorar</b><ul id="cons-list"></ul></div>
    </div>

    <div class="section-title">Historial del d√≠a</div>
    <div id="hoy-historial"></div>
  </section>

  <section id="plan" class="card hidden">
    <div class="small">Rellena ideas (rojo = pendiente). Confirma (verde) o üîÑ regenera por comida. Puedes <b>editar a mano</b> cada casilla.</div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Semana que empieza</label><input type="date" id="week-start" /></div>
      <div class="col" style="align-self:end"><button class="btn alt" id="btn-auto-plan">Rellenar con ideas</button><button class="btn" id="btn-guardar-plan">Guardar plan</button></div>
    </div>
    <div id="plan-grid" class="plan-grid" style="margin-top:12px"></div>
    <div class="small" id="plan-msg"></div>
  </section>

  <section id="lista" class="card hidden">
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Desde</label><input type="date" id="list-from" /></div>
      <div class="col"><label>Hasta</label><input type="date" id="list-to" /></div>
      <div class="col" style="align-self:end"><button class="btn primary" id="btn-generar-lista">Generar lista</button><button class="btn" id="btn-copiar-lista">Copiar</button></div>
    </div>
    <div id="lista-contenido" style="margin-top:10px"></div>
  </section>

  <details class="tests card" style="margin-top:10px">
    <summary>üîß Autotests (diagn√≥stico r√°pido)</summary>
    <ul id="test-results" class="small"></ul>
  </details>
</main>

<script>
// ===== Util
const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const todayStr=()=> new Date().toISOString().slice(0,10);
const weekDays=["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
const mealLabels={desayuno:"Desayuno", snack_am:"Snack ma√±ana", comida:"Comida", merienda:"Merienda", cena:"Cena"};

// ===== Estado
const KEY='nicomida_v33';
let state=load();
function load() {
  try {
    const raw = localStorage.getItem(KEY);
    // Si hay basura en localStorage, intenta repararla borrando la clave
    if (!raw) return { logs: {}, plans: {} };
    const parsed = JSON.parse(raw);
    if (parsed && typeof parsed === 'object' && 'logs' in parsed && 'plans' in parsed) return parsed;
    // Si no es el formato esperado, reset
    localStorage.removeItem(KEY);
    return { logs: {}, plans: {} };
  } catch (e) {
    // Si el JSON est√° corrupto (Unexpected token , etc.), resetea
    try { localStorage.removeItem(KEY); } catch(_) {}
    return { logs: {}, plans: {} };
  }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

// ===== L√©xico / categor√≠as
const PROH={ ingredientes:["tomate","remolacha"], nocturnos:["br√≥coli","brocoli"], maxEggs:5, maxLentejas:1, maxRedMeat:1 };
const LEX={
  'aceite de oliva':{norm:'aceite de oliva', cats:['grasa']}, 'aceite':{norm:'aceite de oliva', cats:['grasa']},
  'pasta corta':{norm:'pasta', cats:['cereal']}, 'pasta':{norm:'pasta', cats:['cereal']}, 'fideos':{norm:'pasta', cats:['cereal']},
  'arroz':{norm:'arroz', cats:['cereal']}, 'quinoa':{norm:'quinoa', cats:['cereal']}, 'cusc√∫s':{norm:'cusc√∫s', cats:['cereal']}, 'cous cous':{norm:'cusc√∫s', cats:['cereal']}, 'pan':{norm:'pan', cats:['cereal']}, 'avena':{norm:'avena', cats:['cereal']},
  'patata':{norm:'patata', cats:['tub√©rculo']}, 'boniato':{norm:'boniato', cats:['tub√©rculo']},
  'pollo':{norm:'pollo', cats:['prote√≠na','carne_blanca']}, 'pavo':{norm:'pavo', cats:['prote√≠na','carne_blanca']}, 'ternera':{norm:'ternera', cats:['prote√≠na','carne_roja']}, 'tortilla':{norm:'huevo', cats:['prote√≠na','huevo']},
  'huevo':{norm:'huevo', cats:['prote√≠na','huevo']}, 'lentejas':{norm:'lentejas', cats:['prote√≠na','legumbre']}, 'garbanzos':{norm:'garbanzos', cats:['prote√≠na','legumbre']},
  'merluza':{norm:'merluza', cats:['prote√≠na','pescado_blanco']}, 'pescado blanco':{norm:'merluza', cats:['prote√≠na','pescado_blanco']}, 'salm√≥n':{norm:'salm√≥n', cats:['prote√≠na','pescado_azul']}, 'salmon':{norm:'salm√≥n', cats:['prote√≠na','pescado_azul']},
  'calabaza':{norm:'calabaza', cats:['verdura']}, 'calabac√≠n':{norm:'calabac√≠n', cats:['verdura']}, 'calabacin':{norm:'calabac√≠n', cats:['verdura']},
  'zanahoria':{norm:'zanahoria', cats:['verdura']}, 'br√≥coli':{norm:'br√≥coli', cats:['verdura']}, 'brocoli':{norm:'br√≥coli', cats:['verdura']}, 'cebolla':{norm:'cebolla', cats:['verdura']}, 'berenjena':{norm:'berenjena', cats:['verdura']}, 'ma√≠z':{norm:'ma√≠z', cats:['cereal']}, 'maiz':{norm:'ma√≠z', cats:['cereal']},
  'aguacate':{norm:'aguacate', cats:['fruta','grasa']}, 'manzana':{norm:'manzana', cats:['fruta']}, 'pera':{norm:'pera', cats:['fruta']}, 'pl√°tano':{norm:'pl√°tano', cats:['fruta']}, 'platano':{norm:'pl√°tano', cats:['fruta']}, 'kiwi':{norm:'kiwi', cats:['fruta']},
  'leche':{norm:'leche', cats:['l√°cteo']}, 'yogur':{norm:'yogur', cats:['l√°cteo']}, 'queso fresco':{norm:'queso fresco', cats:['l√°cteo']}
};
const MULTI=Object.keys(LEX).filter(k=>k.includes(' ')).sort((a,b)=>b.length-a.length);
function toAsciiLower(s){ const map={"√°":"a","√©":"e","√≠":"i","√≥":"o","√∫":"u","√º":"u","√±":"n"}; return s.toLowerCase().split('').map(ch=>map[ch]||ch).join(''); }
function parseFree(text){ const original=text.trim(); if(!original) return null; let t=' '+toAsciiLower(original)+' '; const found=new Set(), cats=new Set(); MULTI.forEach(ph=>{ const p=' '+toAsciiLower(ph)+' '; if(t.includes(p)){ found.add(LEX[ph].norm); LEX[ph].cats.forEach(c=>cats.add(c)); t=t.split(p).join(' ');} }); t.split(/,| y | con | de |\+/g).map(s=>s.trim()).filter(Boolean).forEach(tok=>{ tok=tok.replace(/\b\d+[\w¬™¬∫]*\b/g,'').trim(); if(!tok) return; const k=LEX[tok]?tok:(tok.endsWith('s')?tok.slice(0,-1):tok); if(LEX[k]){ found.add(LEX[k].norm); LEX[k].cats.forEach(c=>cats.add(c)); } }); [...found].forEach(i=>{ if(PROH.ingredientes.includes(i)) found.delete(i); }); return {dish:original, ingredients:[...found], categories:[...cats], ts:Date.now()}; }

// ===== Ideas
const BANK={ base:[
  {title:"Pollo con arroz y calabac√≠n", ing:['pollo','arroz','calabac√≠n','aceite de oliva']},
  {title:"Pavo con boniato y zanahoria", ing:['pavo','boniato','zanahoria','aceite de oliva']},
  {title:"Ternera con patata y calabaza", ing:['ternera','patata','calabaza','aceite de oliva']},
  {title:"Merluza con patata y calabac√≠n", ing:['merluza','patata','calabac√≠n','aceite de oliva']},
  {title:"Salm√≥n con arroz y calabaza", ing:['salm√≥n','arroz','calabaza','aceite de oliva']},
  {title:"Garbanzos con arroz y verduras", ing:['garbanzos','arroz','calabac√≠n','zanahoria','aceite de oliva']},
  {title:"Cusc√∫s con pollo y calabaza", ing:['cusc√∫s','pollo','calabaza','aceite de oliva']},
  {title:"Pasta corta con merluza y calabac√≠n", ing:['pasta','merluza','calabac√≠n','aceite de oliva']}
]};
function ingCats(ing){ const cats=new Set(); (ing||[]).forEach(i=> (LEX[i]?.cats||[]).forEach(c=>cats.add(c))); return cats; }
function isBalanced(ing){ const cats=ingCats(ing); return cats.has('prote√≠na') && (cats.has('cereal')||cats.has('tub√©rculo')) && cats.has('verdura'); }

function weekStartOf(dateStr){ const d=new Date(dateStr); const day=(d.getUTCDay()+6)%7; d.setUTCDate(d.getUTCDate()-day); return d.toISOString().slice(0,10); }
function inWeekRange(dateStr, weekStart){ const d=new Date(dateStr); const w=new Date(weekStart); const diff=(d-w)/86400000; return diff>=0 && diff<7; }
function countersWeek(weekStart){ let eggs=0,lent=0,red=0; for(const d in state.logs){ if(inWeekRange(d,weekStart)){ const day=state.logs[d]; Object.values(day).forEach(e=>{ const ing=e?.ingredients||[]; if(ing.includes('huevo')) eggs++; if(ing.includes('lentejas')) lent++; if(ing.includes('ternera')) red++; }); } } return {eggs,lent,red}; }

function allowedFor(turno, x){ let tlist=[]; if(Array.isArray(x)) tlist=x; else if(typeof x==='string'){ const low=x.toLowerCase(); if(low.includes('tomate')||low.includes('remolacha')) return false; if(turno==='cena' && (low.includes('br√≥coli')||low.includes('brocoli'))) return false; return true; } tlist=(tlist||[]).map(s=> (''+s).toLowerCase()); if(tlist.some(s=> PROH.ingredientes.includes(s))) return false; if(turno==='cena' && (tlist.includes('br√≥coli')||tlist.includes('brocoli'))) return false; return true; }

function preferByContext(turno,dateStr,weekStart,cand){ const today=state.logs[dateStr]||{}; const dayCats=new Set(); Object.values(today).forEach(e=> (e?.ingredients||[]).forEach(i=> (LEX[i]?.cats||[]).forEach(c=>dayCats.add(c)))); const w=countersWeek(weekStart); return cand.filter(item=>{ const cats=ingCats(item.ing); if(item.ing.includes('huevo') && w.eggs>=PROH.maxEggs) return false; if(item.ing.includes('lentejas') && w.lent>=PROH.maxLentejas) return false; if(item.ing.includes('ternera') && w.red>=PROH.maxRedMeat) return false; if(dayCats.has('carne_blanca')||dayCats.has('carne_roja')){ if(cats.has('carne_blanca')||cats.has('carne_roja')) return false; } if(turno==='cena' && (cats.has('carne_blanca')||cats.has('carne_roja'))) return false; return true; }); }
function candidates(turno,dateStr){ const ws=weekStartOf(dateStr); let cand=[...BANK.base].map(x=>({title:x.title, ing:[...x.ing]})); cand=cand.filter(x=> isBalanced(x.ing) && allowedFor(turno,x.ing)); let filtered=preferByContext(turno,dateStr,ws,cand); if(!filtered.length) filtered=cand; return filtered; }
function pickIdea(turno,dateStr){ const list=candidates(turno,dateStr); return list[Math.floor(Math.random()*list.length)]; }

function addLog(date,turno,entry){ if(!state.logs[date]) state.logs[date]={}; state.logs[date][turno]=entry; save(); }
function renderDayHistory(date){ const box=$('#hoy-historial'); box.innerHTML=''; const day=state.logs[date]||{}; ['desayuno','snack_am','comida','merienda','cena'].forEach(t=>{ if(day[t]){ const it=day[t]; const el=document.createElement('div'); el.className='list-item'; el.innerHTML=`<div><div><b>${mealLabels[t]}</b>: ${it.dish||''}</div><div class="small">${(it.ingredients||[]).join(', ')}</div></div><button class="btn">Eliminar</button>`; el.querySelector('button').onclick=()=>{ delete day[t]; save(); renderDayHistory(date); updateMeter(); }; box.appendChild(el); } }); updateMeter(); }

function renderHoySuggestions(){ const turno=$('#hoy-turno').value; const date=$('#hoy-date').value; const list=$('#hoy-sug-list'); list.innerHTML=''; const ids=new Set(); for(let i=0;i<6 && ids.size<4;i++){ const it=pickIdea(turno,date); if(!it||ids.has(it.title)) continue; ids.add(it.title); const el=document.createElement('div'); el.className='suggestion'; el.innerHTML=`<div><div style="font-weight:700">${it.title}</div><div class="small">${it.ing.join(', ')}</div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn alt">Planear</button><button class="btn primary">Registrar</button></div>`; const [planBtn,regBtn]=el.querySelectorAll('button'); planBtn.onclick=()=> quickPlanFromSuggestionStruct(it); regBtn.onclick=()=>{ const date=$('#hoy-date').value; const turno=$('#hoy-turno').value; const cats=ingCats(it.ing); addLog(date, turno, {dish:it.title, ingredients:it.ing, categories:[...cats], ts:Date.now()}); renderDayHistory(date); }; list.appendChild(el); } }

function mealCompleteness(e){ if(!e) return 0; const cats=new Set(e.categories||[]); let s=0; if(cats.has('prote√≠na')) s+=0.4; if(cats.has('cereal')||cats.has('tub√©rculo')) s+=0.3; if(cats.has('verdura')) s+=0.3; return s; }
function updateMeter(){ const date=$('#hoy-date').value; const day=state.logs[date]||{}; const pros=[], cons=[]; const scMeal=mealCompleteness(day.comida); const scDinner=mealCompleteness(day.cena); if(scMeal===1) pros.push('Comida completa (P+C+V)'); else cons.push('Completar la comida con P+C+V'); if(scDinner===1) pros.push('Cena completa (P+C+V)'); else cons.push('Completar la cena con P+C+V'); const catsDay=new Set(); Object.values(day).forEach(e=> (e?.categories||[]).forEach(c=>catsDay.add(c)) ); if(catsDay.has('fruta')) pros.push('Incluiste fruta'); else cons.push('A√±adir fruta en alguna toma'); if(catsDay.has('grasa')||catsDay.has('grasa saludable')) pros.push('Grasa saludable presente'); let score=(scMeal+scDinner)*5; const w=countersWeek(weekStartOf(date)); if(w.eggs>PROH.maxEggs){ score-=1; cons.push('Huevo >5/sem'); } if(w.lent>PROH.maxLentejas){ score-=0.5; cons.push('Lentejas >1/sem'); } if(w.red>PROH.maxRedMeat){ score-=0.5; cons.push('Carne roja >1/sem'); } if(day.cena && (day.cena.ingredients||[]).includes('br√≥coli')){ score-=0.8; cons.push('Evitar br√≥coli por la noche'); } score=Math.max(0,Math.min(10,Math.round(score*2)/2)); $('#needle').style.left=(score*10)+'%'; $('#pros-list').innerHTML=pros.map(x=>`<li>${x}</li>`).join(''); $('#cons-list').innerHTML=cons.filter((v,i,a)=>a.indexOf(v)===i).map(x=>`<li>${x}</li>`).join(''); }

function ensurePlan(ws){ if(!state.plans[ws]) state.plans[ws]=Array.from({length:7},()=>({comida:{},cena:{}})); }
function renderPlan(){ const grid=$('#plan-grid'); const ws=$('#week-start').value; ensurePlan(ws); grid.innerHTML=''; const week=state.plans[ws]; week.forEach((day,idx)=>{ const card=document.createElement('div'); card.className='card'; const date=new Date(ws); date.setUTCDate(date.getUTCDate()+idx); const ds=date.toISOString().slice(0,10);
  const slot=(t)=>{ const s=day[t]||{}; const st=s.confirmed?'confirmed':'pending'; return `<div class="slot ${st}" data-idx="${idx}" data-t="${t}"><div class="small"><b>${t==='comida'?'Comida':'Cena'}</b> <span class="small" style="opacity:.7">${ds}</span></div><input class="inp" value="${s.title||''}" placeholder="Idea de ${t}" /><div class="actions"><span class="icon regen" title="Regenerar">üîÑ</span><span class="icon confirm" title="Confirmar">‚úÖ</span></div></div>`; };
  card.innerHTML=`<div style="font-weight:700;margin-bottom:6px">${weekDays[idx]}</div><div class="plan-grid">${slot('comida')}${slot('cena')}</div>`; grid.appendChild(card); });
  $$('#plan-grid .slot').forEach(sl=>{ const idx=+sl.dataset.idx; const t=sl.dataset.t; const inp=sl.querySelector('.inp'); inp.oninput=e=>{ const ws=$('#week-start').value; const val=e.target.value; const parsed=parseFree(val)||{}; state.plans[ws][idx][t].title=val; state.plans[ws][idx][t].ing=parsed.ingredients||[]; state.plans[ws][idx][t].categories=parsed.categories||[]; save(); }; sl.querySelector('.regen').onclick=()=>{ const ws=$('#week-start').value; const date=new Date(ws); date.setUTCDate(date.getUTCDate()+idx); const ds=date.toISOString().slice(0,10); const idea=pickIdea(t, ds); state.plans[ws][idx][t]={title:idea.title, ing:idea.ing, categories:[...ingCats(idea.ing)], confirmed:false}; save(); renderPlan(); }; sl.querySelector('.confirm').onclick=()=>{ const ws=$('#week-start').value; const s=state.plans[ws][idx][t]; if(!s?.title) return alert('Escribe o genera una idea'); let ing=s.ing && s.ing.length? s.ing : (parseFree(s.title)||{}).ingredients || []; if(!isBalanced(ing)){ const cats=ingCats(ing); if(!(cats.has('cereal')||cats.has('tub√©rculo'))) ing.push('arroz'); if(!cats.has('verdura')) ing.push('calabac√≠n'); if(!cats.has('prote√≠na')) ing.push('pollo'); } s.ing=ing; s.categories=[...ingCats(ing)]; s.confirmed=true; save(); renderPlan(); }; }); }

function autoPlan(){ const ws=$('#week-start').value; ensurePlan(ws); for(let i=0;i<7;i++){ const d=new Date(ws); d.setUTCDate(d.getUTCDate()+i); const ds=d.toISOString().slice(0,10); const c=pickIdea('comida',ds); const z=pickIdea('cena',ds); state.plans[ws][i].comida={title:c.title, ing:c.ing, categories:[...ingCats(c.ing)], confirmed:false}; state.plans[ws][i].cena={title:z.title, ing:z.ing, categories:[...ingCats(z.ing)], confirmed:false}; } save(); renderPlan(); }

function quickPlanFromSuggestionStruct(item){ const ws=$('#week-start').value||weekStartOf($('#hoy-date').value); ensurePlan(ws); const a=new Date(ws), b=new Date($('#hoy-date').value); const idx=Math.round((b-a)/86400000); if(idx<0||idx>6) return alert('La fecha no est√° en la semana seleccionada'); const t=$('#hoy-turno').value; if(!allowedFor(t,item.ing)) return alert('Sugerencia incompatible con tus reglas'); state.plans[ws][idx][t]={title:item.title, ing:item.ing, categories:[...ingCats(item.ing)], confirmed:false}; save(); renderPlan(); }

function generateList(){ const from=$('#list-from').value, to=$('#list-to').value; const items=new Set(); for(const date in state.logs){ if(date>=from&&date<=to){ Object.values(state.logs[date]).forEach(e=> (e.ingredients||[]).forEach(i=> items.add(i))); }} const ws=weekStartOf(from); (state.plans[ws]||[]).forEach((d,di)=>{ const dayDate=new Date(ws); dayDate.setUTCDate(dayDate.getUTCDate()+di); const ds=dayDate.toISOString().slice(0,10); if(ds>=from&&ds<=to){ ['comida','cena'].forEach(t=>{ const s=d[t]; if(s?.confirmed) (s.ing|| (parseFree(s.title)||{}).ingredients || []).forEach(i=> items.add(i)); }); } }); PROH.ingredientes.forEach(p=> items.delete(p)); const cont=$('#lista-contenido'); const arr=[...items].sort(); cont.innerHTML= arr.length? arr.map(i=>`<div class="list-item"><span>${i}</span><button class="btn">‚úîÔ∏è</button></div>`).join(''): '<div class="small">No hay ingredientes en el rango.</div>'; }
function copyList(){ const items=[...$('#lista-contenido').querySelectorAll('.list-item span')].map(el=>el.textContent); navigator.clipboard.writeText(items.join('\n')).then(()=>alert('Lista copiada ‚úÖ')); }

function setTab(id){ ['hoy','plan','lista'].forEach(x=> $('#'+x).classList.toggle('hidden', x!==id)); $$('nav button').forEach(b=> b.classList.toggle('active', b.dataset.tab===id)); }
$$('nav button').forEach(b=> b.onclick=()=> setTab(b.dataset.tab));

function init(){ $('#hoy-date').value=todayStr(); $('#week-start').value=weekStartOf(todayStr()); $('#list-from').value=weekStartOf(todayStr()); const to=new Date($('#list-from').value); to.setUTCDate(to.getUTCDate()+6); $('#list-to').value=to.toISOString().slice(0,10); $('#label-turno').textContent=$('#hoy-turno').selectedOptions[0].textContent; renderHoySuggestions(); renderDayHistory($('#hoy-date').value); renderPlan(); }

$('#btn-hoy-sugerir').onclick=renderHoySuggestions; $('#hoy-turno').onchange=()=> $('#label-turno').textContent=$('#hoy-turno').selectedOptions[0].textContent; $('#btn-parse-alt').onclick=()=>{ const s=$('#alt-plato').value.trim(); if(!s) return alert('Escribe la alternativa'); const e=parseFree(s); const date=$('#hoy-date').value; const turno=$('#hoy-turno').value; addLog(date, turno, e); $('#alt-plato').value=''; renderDayHistory(date); };
$('#save-des').onclick=()=>{ const v=$('#txt-desayuno').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'desayuno',parseFree(v)); $('#txt-desayuno').value=''; renderDayHistory(d); };
$('#save-snack').onclick=()=>{ const v=$('#txt-snack').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'snack_am',parseFree(v)); $('#txt-snack').value=''; renderDayHistory(d); };
$('#save-mer').onclick=()=>{ const v=$('#txt-merienda').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'merienda',parseFree(v)); $('#txt-merienda').value=''; renderDayHistory(d); };
$('#hoy-date').onchange=()=> renderDayHistory($('#hoy-date').value);
$('#btn-auto-plan').onclick=autoPlan; $('#btn-guardar-plan').onclick=()=>{ save(); alert('Plan guardado ‚úÖ'); }; $('#week-start').onchange=renderPlan;
$('#btn-generar-lista').onclick=generateList; $('#btn-copiar-lista').onclick=copyList;

if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();

function runTests(){ const results=[]; const ok=(name,cond)=>results.push({name,pass:!!cond});
  try{
    const p1=parseFree('leche con avena y kiwi'); ok('parser: leche/avena/kiwi', p1 && ['leche','avena','kiwi'].every(x=>p1.ingredients.includes(x)));
    ok('parser: categor√≠as l√°cteo/cereal/fruta', p1 && p1.categories.includes('l√°cteo') && p1.categories.includes('cereal') && p1.categories.includes('fruta'));
    const p2=parseFree('tortilla de calabac√≠n'); ok('parser: tortilla incluye huevo', p2 && p2.ingredients.includes('huevo')); ok('parser: verdura presente', p2 && p2.ingredients.includes('calabac√≠n'));
    const p3=parseFree('tomate y remolacha'); ok('parser: filtra prohibidos', p3 && p3.ingredients.length===0);
    ok('regla cena: no br√≥coli (string)', !allowedFor('cena','Arroz con br√≥coli'));
    ok('regla cena: no br√≥coli (array)', !allowedFor('cena',['arroz','br√≥coli']));
    const backup=localStorage.getItem(KEY); localStorage.setItem(KEY, JSON.stringify({logs:{},plans:{}})); const loaded=load(); ok('load(): objeto v√°lido', loaded && typeof loaded==='object' && 'logs' in loaded && 'plans' in loaded); if(backup===null) localStorage.removeItem(KEY); else localStorage.setItem(KEY, backup);
    try{ const prev=$('#hoy-date').value; $('#hoy-date').value=todayStr(); state.logs[$('#hoy-date').value]={}; updateMeter(); $('#hoy-date').value=prev; ok('updateMeter: seguro con d√≠a vac√≠o', true);}catch(e){ ok('updateMeter: seguro con d√≠a vac√≠o', false); }
    ok('DOM: existe #test-results', !!document.querySelector('#test-results'));
    ok('parseFree: null para cadena vac√≠a', parseFree('   ')===null);
    const idea=pickIdea('comida', todayStr()); ok('idea balanceada', idea && isBalanced(idea.ing));
    const d=todayStr(); state.logs[d]={comida:{ingredients:['pollo'],categories:[...ingCats(['pollo'])]}}; const dinner=pickIdea('cena', d); const dinnerCats=ingCats(dinner.ing); ok('cena evita carne tras carne al mediod√≠a', !(dinnerCats.has('carne_blanca')||dinnerCats.has('carne_roja')));
    const ws=weekStartOf(d); for(let i=0;i<7;i++){ const dt=new Date(ws); dt.setUTCDate(dt.getUTCDate()+i); const ds=dt.toISOString().slice(0,10); state.logs[ds]={comida:{ingredients:['ternera'],categories:[...ingCats(['ternera'])]}}; }
    const noRed=candidates('comida',d).every(x=> !x.ing.includes('ternera')); ok('no sugiere ternera si ya se alcanz√≥ el m√°ximo semanal', noRed);
    try{ $('#list-from').value=ws; const to=new Date(ws); to.setUTCDate(to.getUTCDate()+6); $('#list-to').value=to.toISOString().slice(0,10); generateList(); ok('generateList: sin excepciones', true);}catch(e){ ok('generateList: sin excepciones', false); }
  }catch(err){ ok('Autotests: ejecuci√≥n sin excepciones', false); console.error('Autotests error:', err); }
  const ul=document.querySelector('#test-results'); if(ul){ ul.innerHTML=''; results.forEach(r=>{ const li=document.createElement('li'); li.className=r.pass?'pass':'fail'; li.textContent=(r.pass?'‚úî ':'‚úñ ')+r.name; ul.appendChild(li); }); } console[results.every(r=>r.pass)?'log':'error']('Autotests:', results); }
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', runTests); else runTests();
</script>

<!-- ===== Login auto-compatible (v8/v9/v10) SIN tocar tu Firebase ===== -->
<script>
(function(){
  const bar = document.getElementById('login-bar');
  function showAnon(){ bar.innerHTML = '<span style="color:#64748b">Modo sin login</span>'; }
  function showUser(name){ bar.innerHTML = 'üëã '+name+' ¬∑ <button id="btn-out">Salir</button>'; document.getElementById('btn-out').onclick = ()=>{ if(window.firebase?.auth){ return window.firebase.auth().signOut(); } if(window._authV9){ return window._authV9.signOut(); } }; }
  function showSignin(onSubmit){
    bar.innerHTML = '<form id="login-form" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">'+
      '<input id="auth-email" type="email" placeholder="email" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:999px">'+
      '<input id="auth-pass" type="password" placeholder="contrase√±a" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:999px">'+
      '<button type="submit">Entrar</button>'+
      '<button type="button" id="btn-reg">Crear</button>'+
    '</form>';
    const f=document.getElementById('login-form');
    const reg=document.getElementById('btn-reg');
    f.onsubmit=(e)=>{ e.preventDefault(); const email=document.getElementById('auth-email').value.trim(); const pass=document.getElementById('auth-pass').value; onSubmit('signin', email, pass); };
    reg.onclick=()=>{ const email=document.getElementById('auth-email').value.trim(); const pass=document.getElementById('auth-pass').value; onSubmit('signup', email, pass); };
  }

  // 1) v8 ya cargado
  if(window.firebase && window.firebase.apps && window.firebase.apps.length){
    try{
      const auth = window.firebase.auth();
      auth.onAuthStateChanged(function(user){
        if(user) showUser(user.email || user.uid);
        else showSignin(async (mode, email, pass)=>{
          try{
            if(mode==='signup') await auth.createUserWithEmailAndPassword(email, pass);
            else await auth.signInWithEmailAndPassword(email, pass);
          }catch(err){ alert(err.message||'Error de autenticaci√≥n'); }
        });
      });
      return; // listo v8
    }catch(e){ console.warn('Auth v8 detectado pero fall√≥:', e); }
  }catch(e){ console.warn('Auth v8 detectado pero fall√≥:', e); }
  }

  // 2) v9+ modular con config global/preexistente
  const cfg = window.FIREBASE_CONFIG || window.firebaseConfig || window.__FBCONFIG || (function(){ try{ const tag=document.getElementById('firebase-config'); return tag? JSON.parse(tag.textContent): null; }catch(_){ return null } })();
  if(cfg){
    (async function(){
      try{
        const appMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
        const authMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
        const app = appMod.initializeApp(cfg);
        const auth = authMod.getAuth(app);
        window._authV9 = {signOut: ()=>authMod.signOut(auth)};
        authMod.onAuthStateChanged(auth, (user)=>{
          if(user) showUser(user.email || user.uid);
          else showSignin(async (mode, email, pass)=>{
            try{
              if(mode==='signup') await authMod.createUserWithEmailAndPassword(auth, email, pass);
              else await authMod.signInWithEmailAndPassword(auth, email, pass);
            }catch(err){ alert(err.message||'Error de autenticaci√≥n'); }
          });
        });
      }catch(e){ console.warn('No se pudo cargar Firebase modular:', e); showAnon(); }
    })();
    return;
  }

  // 3) Nada detectado ‚Üí modo local
  showAnon();
})();
</script>
</body>
</html>
