<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nicomida ‚Äì Modo Simple (v4.3.1 Pastel + Firebase Auth, PWA)</title>
<link rel="manifest" id="app-manifest">
<meta name="theme-color" content="#A8E6CF" />
<style>
  :root{
    /* Paleta pastel juvenil */
    --bg:#fafafa;            /* fondo base */
    --ink:#0f172a;           /* texto principal */
    --muted:#6b7280;         /* texto secundario */
    --border:#e5e7eb;        /* l√≠neas suaves */
    --brand:#A8E6CF;         /* menta pastel */
    --brand-2:#FF8B94;       /* coral suave */
    --accent-1:#FFD3B6;      /* vainilla */
    --accent-2:#E0BBE4;      /* lavanda */
    --danger:#ef4444;        /* rojo */
    --warn:#f59e0b;          /* amarillo */
    --ok:#10b981;            /* verde ok */
    --card:#ffffff;          /* tarjeta */
    --card-ghost:rgba(255,255,255,.85);
    --shadow:0 12px 34px rgba(2,6,23,.06), 0 3px 12px rgba(2,6,23,.04);
    --radius:20px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  body{
    color:var(--ink);
    background:
      radial-gradient(900px 600px at 10% -10%, rgba(168,230,207,.55) 0, transparent 45%),
      radial-gradient(900px 600px at 110% -10%, rgba(224,187,228,.45) 0, transparent 45%),
      linear-gradient(180deg, #fff, #fafafa 60%);
  }

  /* Header glassy */
  header{position:sticky;top:0;z-index:40;background:var(--card-ghost);backdrop-filter:saturate(130%) blur(10px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1180px;margin:0 auto;padding:10px 16px}
  h1{margin:0;font-size:22px;display:flex;align-items:center;gap:10px;letter-spacing:.2px}
  h1 .badge{font-size:12px;padding:4px 10px;border-radius:999px;background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  #login-bar{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:6px 16px;font-size:13px}
  #login-bar button{border-radius:999px;border:1px solid var(--border);padding:6px 10px;background:#fff;cursor:pointer}

  /* Tabs */
  nav{display:flex;gap:10px;padding:10px 16px}
  nav button{flex:1;padding:12px 14px;border:1px solid var(--border);background:var(--card);border-radius:999px;cursor:pointer;color:var(--muted);font-weight:700;letter-spacing:.2px;transition:all .2s ease;box-shadow:var(--shadow)}
  nav button:hover{transform:translateY(-1px)}
  nav button.active{background:linear-gradient(180deg, rgba(168,230,207,.9), #ffffff 60%);border-color:#b6f2de;color:#065f46}

  main{max-width:1180px;margin:0 auto;padding:18px}

  /* Cards */
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start}
  .col{flex:1 1 280px}
  label{font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.2px}
  input,select,textarea,button{border-radius:14px;border:1px solid var(--border);background:#fff;color:var(--ink);padding:12px;font-size:14px;transition:border-color .2s, box-shadow .2s}
  input:focus,select:focus,textarea:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
  input,select,textarea{width:100%}
  button{cursor:pointer}

  /* Buttons */
  .btn{background:#f8fafc}
  .btn.primary{background:linear-gradient(135deg, var(--brand), var(--accent-1));color:#073b2c;border-color:rgba(7,59,44,.15);font-weight:800}
  .btn.alt{background:linear-gradient(135deg, var(--brand-2), var(--accent-2));color:#4a0f16;border-color:rgba(74,15,22,.15);font-weight:800}
  .btn.icon{padding:8px 12px;border-radius:12px}

  /* Suggestion card */
  .suggestion{border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0;display:flex;justify-content:space-between;gap:14px;background:#fff}
  .suggestion .title{font-weight:800;letter-spacing:.2px}
  .suggestion .meta{font-size:12px;color:var(--muted)}

  /* List items (history & lista) */
  .list-item{display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--border);border-radius:14px;padding:10px 12px;margin:8px 0;background:#fff}

  .section-title{font-weight:900;margin:14px 0 8px;letter-spacing:.2px}
  .small{font-size:12px;color:var(--muted)}
  .hidden{display:none}

  /* Meter (accelerometer) */
  .meter{position:relative;height:18px;border-radius:999px;background:linear-gradient(90deg,#fecaca,#fde68a,#bbf7d0);border:1px solid var(--border)}
  .needle{position:absolute;top:-8px;transform:translateX(-50%);height:30px;width:3px;background:#111;border-radius:2px;box-shadow:0 6px 12px rgba(0,0,0,.15)}
  .meter-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:6px}
  .proscons{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
  .proscons .box{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
  .proscons ul{margin:6px 0 0 18px;padding:0}

  /* Otras tomas en stack uniforme */
  .stack{display:flex;flex-direction:column;gap:12px}
  .stack .entry{display:flex;flex-direction:column;gap:6px}
  .row-save{display:flex;gap:8px}
  .row-save input{flex:1}
  .row-save button{width:46px}

  /* Plan semanal */
  .plan-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
  .slot{border:1px solid var(--border);border-radius:16px;padding:10px;background:#fff;box-shadow:var(--shadow)}
  .slot.pending{outline:2px dashed #fca5a5;background:#fff5f5}
  .slot.confirmed{outline:2px solid #bbf7d0;background:#f0fdf4}
  .slot .actions{display:flex;gap:8px;margin-top:8px}
  .slot .actions .icon{padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:#f3f4f6;cursor:pointer;transition:transform .15s}
  .slot .actions .icon:hover{transform:translateY(-1px)}

  /* Tests */
  details.tests{margin:14px 0}
  details.tests summary{cursor:pointer;font-weight:700}
  .pass{color:#16a34a}
  .fail{color:#b91c1c}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
    <h1>üçΩÔ∏è Nicomida ‚Äì Modo Simple <span class="badge">v4.3.1</span></h1>
    <div id="login-bar">Cargando sesi√≥n‚Ä¶</div>
  </div>
  <nav class="wrap">
    <button class="active" data-tab="hoy">Hoy</button>
    <button data-tab="plan">Plan semanal</button>
    <button data-tab="lista">Lista</button>
  </nav>
</header>

<main>
  <!-- HOY -->
  <section id="hoy" class="card">
    <div class="row">
      <div class="col">
        <label>Fecha</label>
        <input type="date" id="hoy-date" />
      </div>
      <div class="col">
        <label>Turno principal</label>
        <select id="hoy-turno"><option value="comida">Comida</option><option value="cena">Cena</option></select>
      </div>
      <div class="col" style="align-self:end"><button class="btn primary" id="btn-hoy-sugerir">Sugerir ideas</button></div>
    </div>

    <div id="hoy-sug-list" class="row" style="margin-top:10px"></div>

    <div class="section-title">¬øLe diste otra cosa en la <span id="label-turno">Comida</span>? (texto libre)</div>
    <div class="row">
      <div class="col"><input id="alt-plato" placeholder="Ej.: aguacate con pasta corta y calabac√≠n, con aceite de oliva" /></div>
      <div class="col" style="align-self:end"><button class="btn" id="btn-parse-alt">üíæ Guardar alternativa</button></div>
    </div>

    <div class="section-title">Otras tomas del d√≠a</div>
    <div class="stack">
      <div class="entry">
        <label>Desayuno</label>
        <div class="row-save"><input id="txt-desayuno" placeholder="leche con avena y kiwi" /><button class="btn" id="save-des">üíæ</button></div>
      </div>
      <div class="entry">
        <label>Snack ma√±ana</label>
        <div class="row-save"><input id="txt-snack" placeholder="yogur con pl√°tano" /><button class="btn" id="save-snack">üíæ</button></div>
      </div>
      <div class="entry">
        <label>Merienda</label>
        <div class="row-save"><input id="txt-merienda" placeholder="pera y galleta de avena" /><button class="btn" id="save-mer">üíæ</button></div>
      </div>
    </div>

    <div class="section-title">Puntaje nutricional del d√≠a</div>
    <div class="meter" id="meter"><div class="needle" id="needle" style="left:50%"></div></div>
    <div class="meter-labels"><span>0</span><span>2</span><span>4</span><span>6</span><span>8</span><span>10</span></div>
    <div class="proscons">
      <div class="box"><b>‚úÖ Puntos a favor</b><ul id="pros-list"></ul></div>
      <div class="box"><b>‚ö†Ô∏è Lo que falt√≥/mejorar</b><ul id="cons-list"></ul></div>
    </div>

    <div class="section-title">Historial del d√≠a</div>
    <div id="hoy-historial"></div>
  </section>

  <!-- PLAN -->
  <section id="plan" class="card hidden">
    <div class="small">Rellena ideas (rojo = pendiente). Confirma (verde) o üîÑ regenera por comida. Puedes <b>editar a mano</b> cada casilla.</div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Semana que empieza</label><input type="date" id="week-start" /></div>
      <div class="col" style="align-self:end"><button class="btn alt" id="btn-auto-plan">Rellenar con ideas</button><button class="btn" id="btn-guardar-plan">Guardar plan</button></div>
    </div>
    <div id="plan-grid" class="plan-grid" style="margin-top:12px"></div>
    <div class="small" id="plan-msg"></div>
  </section>

  <!-- LISTA -->
  <section id="lista" class="card hidden">
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Desde</label><input type="date" id="list-from" /></div>
      <div class="col"><label>Hasta</label><input type="date" id="list-to" /></div>
      <div class="col" style="align-self:end"><button class="btn primary" id="btn-generar-lista">Generar lista</button><button class="btn" id="btn-copiar-lista">Copiar</button></div>
    </div>
    <div id="lista-contenido" style="margin-top:10px"></div>
  </section>

  <!-- AUTOTESTS -->
  <details class="tests card" style="margin-top:10px">
    <summary>üîß Autotests (diagn√≥stico r√°pido)</summary>
    <ul id="test-results" class="small"></ul>
  </details>
</main>

<script>
// ===== Util
const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const todayStr=()=> new Date().toISOString().slice(0,10);
const weekDays=["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
const mealLabels={desayuno:"Desayuno", snack_am:"Snack ma√±ana", comida:"Comida", merienda:"Merienda", cena:"Cena"};

// ===== Estado (soporta sesi√≥n: uid -> clave)
const KEY_BASE='nicomida_v43';
let CURRENT_UID=null; // null = an√≥nimo
function storageKey(){ return `${KEY_BASE}_${CURRENT_UID||'anon'}`; }
// Intenta migrar autom√°ticamente desde claves antiguas (no romper lo anterior)
function readLegacyState(){
  try{
    const keys = Object.keys(localStorage).filter(k=>k.startsWith('nicomida_v') || k==='nicomida');
    for(const k of keys){
      try{ const obj = JSON.parse(localStorage.getItem(k)); if(obj && typeof obj==='object' && 'logs' in obj && 'plans' in obj) return obj; }catch(_){ }
    }
  }catch(_){ }
  return {logs:{}, plans:{}};
}
let state=load();
function load() {
  try {
    const cur = localStorage.getItem(storageKey());
    if(cur){ return JSON.parse(cur) || { logs: {}, plans: {} }; }
    // Si no hay estado para la clave actual, trae el legado
    return readLegacyState();
  } catch (e) {
    return { logs: {}, plans: {} };
  }
}, plans: {} };
  } catch (e) {
    return { logs: {}, plans: {} };
  }
}
function save(){
  localStorage.setItem(storageKey(), JSON.stringify(state));
  // Adem√°s, si hay usuario y Firestore disponible, sincroniza
  if(window.db && CURRENT_UID){
    const docRef = window._docRef;
    if(docRef){
      const payload = {updatedAt: Date.now(), data: state};
      window._saveQueue = window._saveQueue || 0;
      clearTimeout(window._saveDebounce);
      window._saveDebounce = setTimeout(async ()=>{
        try{ window._saveQueue++; await window.setDoc(docRef, payload, {merge:true}); }catch(err){ console.warn('Firestore save error', err); }
        finally{ window._saveQueue--; }
      }, 400);
    }
  }
}

// ===== L√©xico / categor√≠as
const PROH={ ingredientes:["tomate","remolacha"], nocturnos:["br√≥coli","brocoli"], maxEggs:5, maxLentejas:1, maxRedMeat:1 };
const LEX={
  'aceite de oliva':{norm:'aceite de oliva', cats:['grasa']}, 'aceite':{norm:'aceite de oliva', cats:['grasa']},
  'pasta corta':{norm:'pasta', cats:['cereal']}, 'pasta':{norm:'pasta', cats:['cereal']}, 'fideos':{norm:'pasta', cats:['cereal']},
  'arroz':{norm:'arroz', cats:['cereal']}, 'quinoa':{norm:'quinoa', cats:['cereal']}, 'cusc√∫s':{norm:'cusc√∫s', cats:['cereal']}, 'cous cous':{norm:'cusc√∫s', cats:['cereal']}, 'pan':{norm:'pan', cats:['cereal']}, 'avena':{norm:'avena', cats:['cereal']},
  'patata':{norm:'patata', cats:['tub√©rculo']}, 'boniato':{norm:'boniato', cats:['tub√©rculo']},
  'pollo':{norm:'pollo', cats:['prote√≠na','carne_blanca']}, 'pavo':{norm:'pavo', cats:['prote√≠na','carne_blanca']}, 'ternera':{norm:'ternera', cats:['prote√≠na','carne_roja']}, 'tortilla':{norm:'huevo', cats:['prote√≠na','huevo']},
  'huevo':{norm:'huevo', cats:['prote√≠na','huevo']}, 'lentejas':{norm:'lentejas', cats:['prote√≠na','legumbre']}, 'garbanzos':{norm:'garbanzos', cats:['prote√≠na','legumbre']},
  'merluza':{norm:'merluza', cats:['prote√≠na','pescado_blanco']}, 'pescado blanco':{norm:'merluza', cats:['prote√≠na','pescado_blanco']}, 'salm√≥n':{norm:'salm√≥n', cats:['prote√≠na','pescado_azul']}, 'salmon':{norm:'salm√≥n', cats:['prote√≠na','pescado_azul']},
  'calabaza':{norm:'calabaza', cats:['verdura']}, 'calabac√≠n':{norm:'calabac√≠n', cats:['verdura']}, 'calabacin':{norm:'calabac√≠n', cats:['verdura']},
  'zanahoria':{norm:'zanahoria', cats:['verdura']}, 'br√≥coli':{norm:'br√≥coli', cats:['verdura']}, 'brocoli':{norm:'br√≥coli', cats:['verdura']}, 'cebolla':{norm:'cebolla', cats:['verdura']}, 'berenjena':{norm:'berenjena', cats:['verdura']}, 'ma√≠z':{norm:'ma√≠z', cats:['cereal']}, 'maiz':{norm:'ma√≠z', cats:['cereal']},
  'aguacate':{norm:'aguacate', cats:['fruta','grasa']}, 'manzana':{norm:'manzana', cats:['fruta']}, 'pera':{norm:'pera', cats:['fruta']}, 'pl√°tano':{norm:'pl√°tano', cats:['fruta']}, 'platano':{norm:'pl√°tano', cats:['fruta']}, 'kiwi':{norm:'kiwi', cats:['fruta']},
  'leche':{norm:'leche', cats:['l√°cteo']}, 'yogur':{norm:'yogur', cats:['l√°cteo']}, 'queso fresco':{norm:'queso fresco', cats:['l√°cteo']}
};
const MULTI=Object.keys(LEX).filter(k=>k.includes(' ')).sort((a,b)=>b.length-a.length);
function toAsciiLower(s){ const map={"√°":"a","√©":"e","√≠":"i","√≥":"o","√∫":"u","√º":"u","√±":"n"}; return s.toLowerCase().split('').map(ch=>map[ch]||ch).join(''); }
function parseFree(text){ const original=text.trim(); if(!original) return null; let t=' '+toAsciiLower(original)+' '; const found=new Set(), cats=new Set(); MULTI.forEach(ph=>{ const p=' '+toAsciiLower(ph)+' '; if(t.includes(p)){ found.add(LEX[ph].norm); LEX[ph].cats.forEach(c=>cats.add(c)); t=t.split(p).join(' ');} }); t.split(/,| y | con | de |\+/g).map(s=>s.trim()).filter(Boolean).forEach(tok=>{ tok=tok.replace(/\b\d+[\w¬™¬∫]*\b/g,'').trim(); if(!tok) return; const k=LEX[tok]?tok:(tok.endsWith('s')?tok.slice(0,-1):tok); if(LEX[k]){ found.add(LEX[k].norm); LEX[k].cats.forEach(c=>cats.add(c)); } }); [...found].forEach(i=>{ if(PROH.ingredientes.includes(i)) found.delete(i); }); return {dish:original, ingredients:[...found], categories:[...cats], ts:Date.now()}; }

// ===== Banco de ideas (sin cantidades, siempre P+C+V)
const BANK={
  base:[
    {title:"Pollo con arroz y calabac√≠n", ing:['pollo','arroz','calabac√≠n','aceite de oliva']},
    {title:"Pavo con boniato y zanahoria", ing:['pavo','boniato','zanahoria','aceite de oliva']},
    {title:"Ternera con patata y calabaza", ing:['ternera','patata','calabaza','aceite de oliva']},
    {title:"Merluza con patata y calabac√≠n", ing:['merluza','patata','calabac√≠n','aceite de oliva']},
    {title:"Salm√≥n con arroz y calabaza", ing:['salm√≥n','arroz','calabaza','aceite de oliva']},
    {title:"Garbanzos con arroz y verduras", ing:['garbanzos','arroz','calabac√≠n','zanahoria','aceite de oliva']},
    {title:"Cusc√∫s con pollo y calabaza", ing:['cusc√∫s','pollo','calabaza','aceite de oliva']},
    {title:"Pasta corta con merluza y calabac√≠n", ing:['pasta','merluza','calabac√≠n','aceite de oliva']}
  ]
};

function ingCats(ing){ const cats=new Set(); (ing||[]).forEach(i=> (LEX[i]?.cats||[]).forEach(c=>cats.add(c))); return cats; }
function isBalanced(ing){ const cats=ingCats(ing); const hasP=cats.has('prote√≠na'); const hasC=cats.has('cereal')||cats.has('tub√©rculo'); const hasV=cats.has('verdura'); return hasP && hasC && hasV; }

// ===== Contexto d√≠a/semana
function weekStartOf(dateStr){ const d=new Date(dateStr); const day=(d.getUTCDay()+6)%7; d.setUTCDate(d.getUTCDate()-day); return d.toISOString().slice(0,10); }
function inWeekRange(dateStr, weekStart){ const d=new Date(dateStr); const w=new Date(weekStart); const diff=(d-w)/86400000; return diff>=0 && diff<7; }
function countersWeek(weekStart){ let eggs=0, lent=0, red=0; for(const d in state.logs){ if(inWeekRange(d,weekStart)){ const day=state.logs[d]; Object.values(day).forEach(e=>{ const ing=e?.ingredients||[]; if(ing.includes('huevo')) eggs++; if(ing.includes('lentejas')) lent++; if(ing.includes('ternera')) red++; }); } } return {eggs,lent,red}; }

// ===== allowedFor compatible (string o array)
function allowedFor(turno, x){ let tlist=[]; if(Array.isArray(x)) tlist=x; else if(typeof x==='string'){ const low=x.toLowerCase(); if(low.includes('tomate')||low.includes('remolacha')) return false; if(turno==='cena' && (low.includes('br√≥coli')||low.includes('brocoli'))) return false; return true; } tlist=(tlist||[]).map(s=> (''+s).toLowerCase()); if(tlist.some(s=> PROH.ingredientes.includes(s))) return false; if(turno==='cena' && (tlist.includes('br√≥coli')||tlist.includes('brocoli'))) return false; return true; }

// ===== Generador consciente de contexto
function preferByContext(turno, dateStr, weekStart, cand){
  const today=state.logs[dateStr]||{}; const dayCats=new Set(); Object.values(today).forEach(e=> (e?.ingredients||[]).forEach(i=> (LEX[i]?.cats||[]).forEach(c=>dayCats.add(c))));
  const w=countersWeek(weekStart);
  return cand.filter(item=>{
    const cats=ingCats(item.ing);
    if(item.ing.includes('huevo') && w.eggs>=PROH.maxEggs) return false;
    if(item.ing.includes('lentejas') && w.lent>=PROH.maxLentejas) return false;
    if(item.ing.includes('ternera') && w.red>=PROH.maxRedMeat) return false;
    if(dayCats.has('carne_blanca')||dayCats.has('carne_roja')){
      if(cats.has('carne_blanca')||cats.has('carne_roja')) return false;
    }
    if(turno==='cena' && (cats.has('carne_blanca')||cats.has('carne_roja'))){ return false; }
    return true;
  });
}
function candidates(turno, dateStr){ const ws=weekStartOf(dateStr); let cand=[...BANK.base].map(x=>({title:x.title, ing:[...x.ing]})); cand=cand.filter(x=> isBalanced(x.ing) && allowedFor(turno,x.ing)); let filtered=preferByContext(turno, dateStr, ws, cand); if(!filtered.length) filtered=cand; return filtered; }
function pickIdea(turno, dateStr){ const list=candidates(turno,dateStr); return list[Math.floor(Math.random()*list.length)]; }

// ===== Registro / historial
function addLog(date, turno, entry){ if(!state.logs[date]) state.logs[date]={}; state.logs[date][turno]=entry; save(); }
function renderDayHistory(date){ const box=$('#hoy-historial'); box.innerHTML=''; const day=state.logs[date]||{}; ['desayuno','snack_am','comida','merienda','cena'].forEach(t=>{ if(day[t]){ const it=day[t]; const el=document.createElement('div'); el.className='list-item'; el.innerHTML=`<div><div><b>${mealLabels[t]}</b>: ${it.dish||''}</div><div class="small">${(it.ingredients||[]).join(', ')}</div></div><button class="btn">Eliminar</button>`; el.querySelector('button').onclick=()=>{ delete day[t]; save(); renderDayHistory(date); updateMeter(); }; box.appendChild(el); } }); updateMeter(); }

// ===== Sugerencias de HOY
function renderHoySuggestions(){ const turno=$('#hoy-turno').value; const date=$('#hoy-date').value; const list=$('#hoy-sug-list'); list.innerHTML=''; const ids=new Set(); for(let i=0;i<6 && ids.size<4;i++){ const it=pickIdea(turno,date); if(!it||ids.has(it.title)) continue; ids.add(it.title); const el=document.createElement('div'); el.className='suggestion'; el.innerHTML=`<div><div style="font-weight:700">${it.title}</div><div class="small">${it.ing.join(', ')}</div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn alt">Planear</button><button class="btn primary">Registrar</button></div>`; const [planBtn,regBtn]=el.querySelectorAll('button'); planBtn.onclick=()=> quickPlanFromSuggestionStruct(it); regBtn.onclick=()=>{ const date=$('#hoy-date').value; const turno=$('#hoy-turno').value; const cats=ingCats(it.ing); addLog(date, turno, {dish:it.title, ingredients:it.ing, categories:[...cats], ts:Date.now()}); renderDayHistory(date); }; list.appendChild(el); }
}

// ===== Aceler√≥metro (eval√∫a comida y cena completas)
function mealCompleteness(e){ if(!e) return 0; const cats=new Set(e.categories||[]); const hasP=cats.has('prote√≠na'); const hasC=cats.has('cereal')||cats.has('tub√©rculo'); const hasV=cats.has('verdura'); let s=0; if(hasP) s+=0.4; if(hasC) s+=0.3; if(hasV) s+=0.3; return s; }
function updateMeter(){ const date=$('#hoy-date').value; const day=state.logs[date]||{}; const pros=[], cons=[]; const scMeal=mealCompleteness(day.comida); const scDinner=mealCompleteness(day.cena); if(scMeal===1) pros.push('Comida completa (P+C+V)'); else cons.push('Completar la comida con P+C+V'); if(scDinner===1) pros.push('Cena completa (P+C+V)'); else cons.push('Completar la cena con P+C+V'); const catsDay=new Set(); Object.values(day).forEach(e=> (e?.categories||[]).forEach(c=>catsDay.add(c)) ); if(catsDay.has('fruta')) pros.push('Incluiste fruta'); else cons.push('A√±adir fruta en alguna toma'); if(catsDay.has('grasa')||catsDay.has('grasa saludable')) pros.push('Grasa saludable presente'); let score=(scMeal+scDinner)*5; const w=countersWeek(weekStartOf(date)); if(w.eggs>PROH.maxEggs){ score-=1; cons.push('Huevo >5/sem'); } if(w.lent>PROH.maxLentejas){ score-=0.5; cons.push('Lentejas >1/sem'); } if(w.red>PROH.maxRedMeat){ score-=0.5; cons.push('Carne roja >1/sem'); } if(day.cena && (day.cena.ingredients||[]).includes('br√≥coli')){ score-=0.8; cons.push('Evitar br√≥coli por la noche'); } score=Math.max(0,Math.min(10,Math.round(score*2)/2)); $('#needle').style.left=(score*10)+'%'; $('#pros-list').innerHTML=pros.map(x=>`<li>${x}</li>`).join(''); $('#cons-list').innerHTML=cons.filter((v,i,a)=>a.indexOf(v)===i).map(x=>`<li>${x}</li>`).join(''); }

// ===== Plan semanal (editable + consciente de contexto)
function ensurePlan(ws){ if(!state.plans[ws]) state.plans[ws]=Array.from({length:7},()=>({comida:{},cena:{}})); }
function renderPlan(){ const grid=$('#plan-grid'); const ws=$('#week-start').value; ensurePlan(ws); grid.innerHTML=''; const week=state.plans[ws]; week.forEach((day,idx)=>{ const card=document.createElement('div'); card.className='card'; const date=new Date(ws); date.setUTCDate(date.getUTCDate()+idx); const ds=date.toISOString().slice(0,10);
  const slot=(t)=>{ const s=day[t]||{}; const st=s.confirmed?'confirmed':'pending'; return `<div class="slot ${st}" data-idx="${idx}" data-t="${t}"><div class="small"><b>${t==='comida'?'Comida':'Cena'}</b> <span class="small" style="opacity:.7">${ds}</span></div><input class="inp" value="${s.title||''}" placeholder="Idea de ${t}" /><div class="actions"><span class="icon regen" title="Regenerar">üîÑ</span><span class="icon confirm" title="Confirmar">‚úÖ</span></div></div>`; };
  card.innerHTML=`<div style="font-weight:700;margin-bottom:6px">${weekDays[idx]}</div><div class="plan-grid">${slot('comida')}${slot('cena')}</div>`; grid.appendChild(card); });
  $$('#plan-grid .slot').forEach(sl=>{ const idx=+sl.dataset.idx; const t=sl.dataset.t; const inp=sl.querySelector('.inp'); inp.oninput=e=>{ const ws=$('#week-start').value; const val=e.target.value; const parsed=parseFree(val)||{}; state.plans[ws][idx][t].title=val; state.plans[ws][idx][t].ing=parsed.ingredients||[]; state.plans[ws][idx][t].categories=parsed.categories||[]; save(); }; sl.querySelector('.regen').onclick=()=>{ const ws=$('#week-start').value; const date=new Date(ws); date.setUTCDate(date.getUTCDate()+idx); const ds=date.toISOString().slice(0,10); const idea=pickIdea(t, ds); state.plans[ws][idx][t]={title:idea.title, ing:idea.ing, categories:[...ingCats(idea.ing)], confirmed:false}; save(); renderPlan(); }; sl.querySelector('.confirm').onclick=()=>{ const ws=$('#week-start').value; const s=state.plans[ws][idx][t]; if(!s?.title) return alert('Escribe o genera una idea'); let ing=s.ing && s.ing.length? s.ing : (parseFree(s.title)||{}).ingredients || []; if(!isBalanced(ing)){ const cats=ingCats(ing); if(!(cats.has('cereal')||cats.has('tub√©rculo'))) ing.push('arroz'); if(!cats.has('verdura')) ing.push('calabac√≠n'); if(!cats.has('prote√≠na')) ing.push('pollo'); } s.ing=ing; s.categories=[...ingCats(ing)]; s.confirmed=true; save(); renderPlan(); }; }); }

function autoPlan(){ const ws=$('#week-start').value; ensurePlan(ws); for(let i=0;i<7;i++){ const d=new Date(ws); d.setUTCDate(d.getUTCDate()+i); const ds=d.toISOString().slice(0,10); const c=pickIdea('comida',ds); const z=pickIdea('cena',ds); state.plans[ws][i].comida={title:c.title, ing:c.ing, categories:[...ingCats(c.ing)], confirmed:false}; state.plans[ws][i].cena={title:z.title, ing:z.ing, categories:[...ingCats(z.ing)], confirmed:false}; } save(); renderPlan(); }

function quickPlanFromSuggestionStruct(item){ const ws=$('#week-start').value||weekStartOf($('#hoy-date').value); ensurePlan(ws); const a=new Date(ws), b=new Date($('#hoy-date').value); const idx=Math.round((b-a)/86400000); if(idx<0||idx>6) return alert('La fecha no est√° en la semana seleccionada'); const t=$('#hoy-turno').value; if(!allowedFor(t,item.ing)) return alert('Sugerencia incompatible con tus reglas'); state.plans[ws][idx][t]={title:item.title, ing:item.ing, categories:[...ingCats(item.ing)], confirmed:false}; save(); renderPlan(); }

// ===== Lista de la compra (logs + plan confirmado)
function generateList(){ const from=$('#list-from').value, to=$('#list-to').value; const items=new Set(); for(const date in state.logs){ if(date>=from&&date<=to){ Object.values(state.logs[date]).forEach(e=> (e.ingredients||[]).forEach(i=> items.add(i))); }} const ws=weekStartOf(from); (state.plans[ws]||[]).forEach((d,di)=>{ const dayDate=new Date(ws); dayDate.setUTCDate(dayDate.getUTCDate()+di); const ds=dayDate.toISOString().slice(0,10); if(ds>=from&&ds<=to){ ['comida','cena'].forEach(t=>{ const s=d[t]; if(s?.confirmed) (s.ing|| (parseFree(s.title)||{}).ingredients || []).forEach(i=> items.add(i)); }); } }); PROH.ingredientes.forEach(p=> items.delete(p)); const cont=$('#lista-contenido'); const arr=[...items].sort(); cont.innerHTML= arr.length? arr.map(i=>`<div class="list-item"><span>${i}</span><button class="btn">‚úîÔ∏è</button></div>`).join(''): '<div class="small">No hay ingredientes en el rango.</div>'; }
function copyList(){ const items=[...$('#lista-contenido').querySelectorAll('.list-item span')].map(el=>el.textContent); navigator.clipboard.writeText(items.join('\n')).then(()=>alert('Lista copiada ‚úÖ')); }

// ===== Tabs & init
function setTab(id){ ['hoy','plan','lista'].forEach(x=> $('#'+x).classList.toggle('hidden', x!==id)); $$('nav button').forEach(b=> b.classList.toggle('active', b.dataset.tab===id)); }
$$('nav button').forEach(b=> b.onclick=()=> setTab(b.dataset.tab));

function init(){ $('#hoy-date').value=todayStr(); $('#week-start').value=weekStartOf(todayStr()); $('#list-from').value=weekStartOf(todayStr()); const to=new Date($('#list-from').value); to.setUTCDate(to.getUTCDate()+6); $('#list-to').value=to.toISOString().slice(0,10); $('#label-turno').textContent=$('#hoy-turno').selectedOptions[0].textContent; renderHoySuggestions(); renderDayHistory($('#hoy-date').value); renderPlan(); }

// Eventos HOY
$('#btn-hoy-sugerir').onclick=renderHoySuggestions; $('#hoy-turno').onchange=()=> $('#label-turno').textContent=$('#hoy-turno').selectedOptions[0].textContent; $('#btn-parse-alt').onclick=()=>{ const s=$('#alt-plato').value.trim(); if(!s) return alert('Escribe la alternativa'); const e=parseFree(s); const date=$('#hoy-date').value; const turno=$('#hoy-turno').value; addLog(date, turno, e); $('#alt-plato').value=''; renderDayHistory(date); };
$('#save-des').onclick=()=>{ const v=$('#txt-desayuno').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'desayuno',parseFree(v)); $('#txt-desayuno').value=''; renderDayHistory(d); };
$('#save-snack').onclick=()=>{ const v=$('#txt-snack').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'snack_am',parseFree(v)); $('#txt-snack').value=''; renderDayHistory(d); };
$('#save-mer').onclick=()=>{ const v=$('#txt-merienda').value.trim(); if(!v) return; const d=$('#hoy-date').value; addLog(d,'merienda',parseFree(v)); $('#txt-merienda').value=''; renderDayHistory(d); };
$('#hoy-date').onchange=()=> renderDayHistory($('#hoy-date').value);

// Plan
$('#btn-auto-plan').onclick=autoPlan; $('#btn-guardar-plan').onclick=()=>{ save(); alert('Plan guardado ‚úÖ'); }; $('#week-start').onchange=renderPlan;

// Lista
$('#btn-generar-lista').onclick=generateList; $('#btn-copiar-lista').onclick=copyList;

if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();

// ===== Autotests =====
function runTests(){ const results=[]; const ok=(name,cond)=>results.push({name,pass:!!cond});
  try{
    const p1=parseFree('leche con avena y kiwi'); ok('parser: leche/avena/kiwi', p1 && ['leche','avena','kiwi'].every(x=>p1.ingredients.includes(x)));
    ok('parser: categor√≠as l√°cteo/cereal/fruta', p1 && p1.categories.includes('l√°cteo') && p1.categories.includes('cereal') && p1.categories.includes('fruta'));
    const p2=parseFree('tortilla de calabac√≠n'); ok('parser: tortilla incluye huevo', p2 && p2.ingredients.includes('huevo')); ok('parser: verdura presente', p2 && p2.ingredients.includes('calabac√≠n'));
    const p3=parseFree('tomate y remolacha'); ok('parser: filtra prohibidos', p3 && p3.ingredients.length===0);
    ok('regla cena: no br√≥coli (string)', !allowedFor('cena','Arroz con br√≥coli'));
    ok('regla cena: no br√≥coli (array)', !allowedFor('cena',['arroz','br√≥coli']));
    const backup=localStorage.getItem(storageKey()); localStorage.setItem(storageKey(), JSON.stringify({logs:{},plans:{}})); const loaded=load(); ok('load(): objeto v√°lido', loaded && typeof loaded==='object' && 'logs' in loaded && 'plans' in loaded); if(backup===null) localStorage.removeItem(storageKey()); else localStorage.setItem(storageKey(), backup);
    try{ const prev=$('#hoy-date').value; $('#hoy-date').value=todayStr(); state.logs[$('#hoy-date').value]={}; updateMeter(); $('#hoy-date').value=prev; ok('updateMeter: seguro con d√≠a vac√≠o', true);}catch(e){ ok('updateMeter: seguro con d√≠a vac√≠o', false); }
    ok('DOM: existe #test-results', !!document.querySelector('#test-results'));
    ok('parseFree: null para cadena vac√≠a', parseFree('   ')===null);
    // Generador balanceado
    const idea=pickIdea('comida', todayStr()); ok('idea balanceada', idea && isBalanced(idea.ing));
    // Cena evita carne si hubo carne al mediod√≠a
    const d=todayStr(); state.logs[d]={comida:{ingredients:['pollo'],categories:[...ingCats(['pollo'])]}}; const dinner=pickIdea('cena', d); const dinnerCats=ingCats(dinner.ing); ok('cena evita carne tras carne al mediod√≠a', !(dinnerCats.has('carne_blanca')||dinnerCats.has('carne_roja')));
    // Semanal: limita carne roja
    const ws=weekStartOf(d); for(let i=0;i<7;i++){ const dt=new Date(ws); dt.setUTCDate(dt.getUTCDate()+i); const ds=dt.toISOString().slice(0,10); state.logs[ds]={comida:{ingredients:['ternera'],categories:[...ingCats(['ternera'])]}}; }
    const noRed=candidates('comida',d).every(x=> !x.ing.includes('ternera')); ok('no sugiere ternera si ya se alcanz√≥ el m√°ximo semanal', noRed);
    // generateList no lanza
    try{ $('#list-from').value=ws; const to=new Date(ws); to.setUTCDate(to.getUTCDate()+6); $('#list-to').value=to.toISOString().slice(0,10); generateList(); ok('generateList: sin excepciones', true);}catch(e){ ok('generateList: sin excepciones', false); }
  }catch(err){ ok('Autotests: ejecuci√≥n sin excepciones', false); console.error('Autotests error:', err); }
  const ul=document.querySelector('#test-results'); if(ul){ ul.innerHTML=''; results.forEach(r=>{ const li=document.createElement('li'); li.className=r.pass?'pass':'fail'; li.textContent=(r.pass?'‚úî ':'‚úñ ')+r.name; ul.appendChild(li); }); } console[results.every(r=>r.pass)?'log':'error']('Autotests:', results); }
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', runTests); else runTests();
</script>

<!-- ===== Firebase (Auth + Firestore) OPCIONAL. Usa la misma config de ANTES si est√° presente ===== -->
<script type="module">
  // *** No cambies nada si ya ten√≠as tu config ***
  // La app intentar√° leer en este orden:
  // 1) <script id="firebase-config">{...}</script> (JSON inline)
  // 2) window.FIREBASE_CONFIG o window.firebaseConfig o window.__FBCONFIG (inyectado por tu archivo anterior)
  // 3) Si no hay config, funciona en modo localStorage sin login.
  function getExistingFirebaseConfig(){
    try{
      const tag = document.getElementById('firebase-config');
      if(tag && tag.textContent){ return JSON.parse(tag.textContent); }
    }catch(_){ }
    return window.FIREBASE_CONFIG || window.firebaseConfig || window.__FBCONFIG || null;
  }
  const firebaseConfig = getExistingFirebaseConfig();
  if(!firebaseConfig){
    console.warn('Sin firebaseConfig: modo localStorage (sin login)');
    document.getElementById('login-bar').innerHTML = `<span style="color:#6b7280">Modo sin login</span>`;
  } else {
    try{
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      window.db = db; // expone para save()
      window.setDoc = setDoc; // para save() con debounce

      const loginBar = document.getElementById('login-bar');
      const provider = new GoogleAuthProvider();
      window._docRef = null;

      async function loadRemote(uid){
        window._docRef = doc(db, 'nicomida_users', uid);
        const snap = await getDoc(window._docRef);
        if(snap.exists()){
          const remote = snap.data()?.data;
          if(remote && typeof remote === 'object'){
            const local = state || {logs:{},plans:{}};
            state = { logs: {...local.logs, ...remote.logs}, plans: {...local.plans, ...remote.plans} };
            save();
          }
        } else {
          await setDoc(window._docRef, {createdAt: Date.now(), data: state});
        }
      }

      function renderLogin(user){
        if(user){
          loginBar.innerHTML = `üëã ${user.displayName || user.email} ¬∑ <button id="btn-out">Salir</button>`;
          document.getElementById('btn-out').onclick = ()=> signOut(auth);
        } else {
          loginBar.innerHTML = `<button id="btn-in">Entrar con Google</button>`;
          document.getElementById('btn-in').onclick = ()=> signInWithPopup(auth, provider);
        }
      }

      onAuthStateChanged(auth, async (user)=>{
        CURRENT_UID = user ? user.uid : null;
        state = load(); // recarga con clave por uid ANTES de mezclar remoto
        renderLogin(user);
        if(user){ await loadRemote(user.uid); }
        try{ renderDayHistory(document.getElementById('hoy-date').value); renderPlan(); }catch(e){}
      });
    }catch(e){
      console.warn('Firebase no carg√≥; usando solo localStorage', e);
      const loginBar = document.getElementById('login-bar');
      loginBar.innerHTML = `<span style=\"color:#6b7280\">Modo sin login</span>`;
    }
  }
</script>

<!-- ===== PWA: manifest din√°mico + service worker ligero ===== -->
<script>
  // Manifest m√≠nimo en memoria (puedes moverlo a /manifest.webmanifest)
  const manifest = {
    name: "Nicomida ‚Äì Modo Simple",
    short_name: "Nicomida",
    start_url: ".",
    display: "standalone",
    background_color: "#ffffff",
    theme_color: "#A8E6CF",
    icons: []
  };
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
  document.getElementById('app-manifest').setAttribute('href', URL.createObjectURL(blob));

  // Service Worker inline via Blob (en producci√≥n usa /sw.js)
  const swCode = `self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open('nicomida-v1').then(c=>c.addAll(['./'])));});
self.addEventListener('activate', e=> self.clients.claim());
self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });`;
  if('serviceWorker' in navigator){
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(console.warn);
  }
</script>
</body>
</html>